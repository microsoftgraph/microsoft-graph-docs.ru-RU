---
title: Использование API Поиска (Майкрософт) для запросов данных
description: С помощью API поиска приложения могут искать данные Microsoft 365 в контексте пользователя, прошедшего проверку подлинности.
ms.localizationpriority: high
author: nmoreau
ms.prod: search
doc_type: resourcePageType
ms.openlocfilehash: 49fbbcef1cb43158894517ea41c90fbe2912b3c7
ms.sourcegitcommit: 8f54d85e8e8b0a1f72d4557d2bb7749b972dd3e2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/17/2022
ms.locfileid: "66141646"
---
# <a name="use-the-microsoft-search-api-to-query-data"></a>Использование API Поиска (Майкрософт) для запросов данных

Вы можете использовать API Поиска (Майкрософт) для запроса данных Microsoft 365 в своих приложениях.

Поисковые запросы выполняются в контексте вошедшего пользователя, указанного [маркером доступа с делегированными разрешениями](/graph/auth-v2-user).

## <a name="common-use-cases"></a>Основные варианты использования

API Microsoft Search предоставляет метод [query](../api/search-query.md) для поиска по данным в Microsoft Search; в этот метод передается [searchRequest](searchRequest.md) в теле запроса, определяя характер поиска.

В этом разделе перечислены распространенные варианты использования метода **query** с применением свойств и параметров, заданных в тексте запроса **query** [searchRequest](searchRequest.md).

Поисковые запросы выполняются от имени пользователя. Результаты поиска ограничиваются для применения правил контроля доступа к элементам.  Например, в контексте файлов разрешения для них оцениваются в составе поискового запроса. Пользователь не может обратиться в результатах поиска к большему количеству элементов, чем он мог бы получить из соответствующей операции GET с теми же разрешениями и управлением доступом.

| Варианты использования | Свойства, определяемые в тексте запроса query |
|:------------------|:---------|
|[Результаты поиска в области по типам объектов](#scope-search-based-on-entity-types)| **entityTypes** |
|[Результаты со страницы](#page-search-results) | **from** и **size** |
|[Получение наиболее релевантных электронных писем](#get-the-most-relevant-emails) | **enableTopResults** |
|[Получение выбранных свойств](#get-selected-properties) | **fields** |
|[Использование KQL в терминах запросов](#keyword-query-language-kql-support) | **query** |
|[Сортировка результатов поиска](#sort-search-results)| **sort** |
|[Уточнение результатов с помощью агрегатов](#refine-results-using-aggregations)| **aggregations** |
|[Исправление орфографии в запросе](#request-spelling-correction)| **queryAlterationOptions** |
|[Макет отображения при поиске](#search-display-layout) (предварительная версия)| **resultTemplateOptions**|

## <a name="scope-search-based-on-entity-types"></a>Поиск в области по типам объектов

Область действия поискового запроса определяется с помощью свойства **entityTypes** полезных данных запроса **query**.
В следующей таблице описаны доступные типы запросов и поддерживаемые разрешения на доступ к данным.

| EntityType | Область разрешений, необходимая для доступа к элементам| Источник| Примечание|
|:------------------|:---------|:---------|:---------|
|[message](message.md)|Mail.Read, Mail.ReadWrite| Exchange Online| Сообщения электронной почты.|
|[event](event.md) |Calendars.Read, Calendars.ReadWrite| Exchange Online|События календаря. |
|[drive](drive.md)|Files.Read.All, Files.ReadWrite.All, Sites.Read.All, Sites.ReadWrite.All| SharePoint | Библиотеки документов.|
|[driveItem](driveitem.md)|Files.Read.All, Files.ReadWrite.All, Sites.Read.All, Sites.ReadWrite.All| SharePoint и OneDrive | Файлы, папки, страницы и новости. |
|[list](list.md)|Sites.Read.All, Sites.ReadWrite.All| SharePoint и OneDrive | Списки Учтите, что библиотеки документов также возвращаются как списки. |
|[listItem](listitem.md)|Sites.Read.All, Sites.ReadWrite.All| SharePoint и OneDrive | Элементы списка. Учтите, что файлы и папки также возвращаются как элементы списка; **listItem** — это суперкласс **driveItem**. |
|[site](site.md)|Sites.Read.All, Sites.ReadWrite.All| SharePoint | Сайты в SharePoint.|

## <a name="page-search-results"></a>Результаты поиска на странице

Управляйте разбивкой результатов поиска на страницы, указав описанные ниже два свойства в тексте запроса **query**.

- **from** — целое значение, указывающее начальную точку (начиная с 0) для перечисления результатов поиска на странице. Значение по умолчанию равно 0.

- **size** — целое число, обозначающее количество результатов, возвращаемых для страницы. Кол-во результатов по умолчанию: 25. Максимальное кол-во результатов: 1000.

При поиске объекта **event** или **message** учитывайте указанные ниже ограничения.

- Значение **from** должно начинаться с нуля для запроса первой страницы. В противном случае запрос возвращает ошибку HTTP 400 `Bad request`.
- Максимальное кол-во результатов на странице (**size**) составляет 25 для **message** и **event**. 

Для SharePoint и OneDrive ограничений нет. Рекомендуемый размер страницы — 200. Чем больше размер страницы, тем, как правило, больше задержка.

Рекомендации:

- В исходном запросе задайте меньший размер первой страницы. Например, задайте для свойства **from** значение 0, а для свойства **size** — 25.
- Для получения последующих страниц обновите свойства **from** и **size**. Вы можете увеличивать размер страницы в каждом последующем запросе. В приведенной ниже таблице показан пример.


    | Страница | from | size |
    |:-----|:-----|:-----|
    | 1    | 0 | 25 |
    | 2    | 25 | 50 |
    | 3    | 75 | 75 |
    | 4    | 150 | 100 |

## <a name="get-the-most-relevant-emails"></a>Получение наиболее релевантных электронных писем

Если при поиске объекта **message** задать для свойства **enableTopResults** значение `true`, возвращается гибридный список сообщений: первые три сообщения в отклике сортируются по релевантности, а остальные — по дате/времени.

## <a name="get-selected-properties"></a>Получение выбранных свойств

При поиске по типу сущности, например **message**, **event**, **drive**, **driveItem**, **list**, **listItem**, **site**, **externalItem**, можно включить в свойство **itfields** определенные свойства сущности, которые следует возвратить в результатах поиска. Аналогично используется [параметр $select системного запроса OData](/graph/query-parameters#select-parameter) в запросах REST. API поиска не поддерживает эти параметры запроса, так как их действие подавляется в теле запроса POST.

Для всех этих типов сущностей указание свойства **fields** сокращает количество свойств, возвращаемых в отклике, что оптимизирует нагрузку на линию.

**listItem** и **externalItem** — единственные поддерживаемые сущности, которые позволяют настройку расширенных извлекаемых полей в схеме. Из всех других сущностей расширенные свойства невозможно извлечь путем применения API поиска. Например, если вы создали извлекаемое поле для **externalItem** в схеме поиска или у вас есть извлекаемый пользовательский столбец в **listItem**, вы можете извлечь эти свойства из результатов поиска. Чтобы получить расширенное свойство файла, укажите в запросе тип **listItem**.

Если **поля**, указанные в запросе, отсутствуют в схеме или не помечены как извлекаемые, они не будут возвращены в отклике. Недопустимые поля в запросе игнорируются без уведомления.

Если в запросе отсутствуют поля, указанные в свойстве **fields**, вы получите набор свойств для всех типов по умолчанию. При использовании расширенных свойств **listItem** и **externalItem** ведут себя иначе, если поля, указанные в свойстве **fields**, не переданы в запрос.

- **listItem** не возвращает никаких настраиваемых полей.
- **externalItem** возвращает все поля с атрибутом **retrievable** в схеме соединителя Microsoft Graph для этого конкретного подключения.

## <a name="keyword-query-language-kql-support"></a>Поддержка языка KQL

Вы можете указать произвольный текст ключевых слов (например, `AND` и `OR`) и ограничения свойств в синтаксисе KQL в фактической строке поискового запроса (свойства **query** в тексте запроса **query**). Синтаксис и команда зависят от типов объектов (в свойстве **entityTypes**), указанных в тексте того же запроса **query**.

Свойства, доступные для поиска, зависят от типа объекта. Дополнительные сведения см. в следующих статьях:

- [Свойства электронной почты](/microsoft-365/compliance/keyword-queries-and-search-conditions#searchable-email-properties)
- [Свойства сайта](/microsoft-365/compliance/keyword-queries-and-search-conditions#searchable-site-properties)

## <a name="sort-search-results"></a>Сортировка результатов поиска

Результаты поиска в отклике отсортированы в следующем стандартном порядке:

- **message** и **event** сортируются по дате.
- Все типы SharePoint, OneDrive, пользователей и соединителей сортируются по релевантности.

Метод [query](../api/search-query.md) позволяет задать порядок поиска, указав **sortProperties** в параметре `requests`, который представляет собой набор объектов [searchRequest](./searchrequest.md). Это дает возможность указать список из одного или нескольких сортируемых средств и порядок сортировки.

Учтите, что сортировка результатов в настоящее время поддерживается только для следующих типов SharePoint и OneDrive: [driveItem](driveitem.md), [listItem](listitem.md), [list](list.md), [site](site.md).

Свойства, к которым применяется предложение sort, должны быть сортируемыми в [схеме поиска](/sharepoint/manage-search-schema) SharePoint. Если свойство, указанное в запросе, не является сортируемым или не существует, в отклике будет возвращена ошибка `HTTP 400 Bad Request`. Обратите внимание, что нельзя задать сортировку документов по релевантности с использованием [sortProperty](sortproperty.md).

При указании параметра **name** объекта [sortProperty](sortproperty.md) можно использовать имя свойства из типа Microsoft Graph (например, в [driveItem](driveitem.md)) или имя управляемого свойств в индексе поиска.

Примеры сортировки результатов см. в разделе [Сортировка результатов поиска](/graph/search-concept-sort).

## <a name="refine-results-using-aggregations"></a>Уточнение результатов с помощью агрегатов

Агрегаты (также называемые уточнениями в SharePoint) — это очень популярное средство, которое позволяет расширить возможности поиска. В дополнение к результатам они предоставляют некоторые обобщенные сведения о наборе данных, из которого получены результатов поиска. Например, можно представить сведения о наиболее заметных авторах документов, которые удовлетворяют запросу, или о самых распространенных типах файлов и т. д.

В [searchRequest](./searchrequest.md) укажите агрегаты, которые надо получить в дополнение к результатам поиска. Описание каждого агрегата приведено в [aggregationOption](./aggregationoption.md), где указывается свойство, на основе которого будет рассчитываться агрегат, и количество объектов [searchBucket](searchBucket.md), возвращаемое в отклике.

Свойства, по которым запрашивается агрегат, должны быть уточняемыми в [схеме поиска](/sharepoint/manage-search-schema) SharePoint. Если указанное свойство не является уточняемым или не существует, отклик возвращает`HTTP 400 Bad Request`.

Когда будет получен отклик, содержащий набор объектов [searchBucket](searchBucket.md), можно уточнить поисковый запрос, ограничив его только совпадающими элементами из одного объекта [searchBucket](searchBucket.md). Это достигается путем передачи значения **aggregationsFilterToken** в свойстве **aggregationFilters** последующего [searchRequest](./searchrequest.md).

В настоящий момент агрегаты поддерживаются для любого свойства с возможностью уточнения в следующих типах SharePoint и OneDrive: [driveItem](driveitem.md), [listItem](listitem.md), [list](list.md), [site](site.md) и в соединителях Microsoft Graph [externalItem](externalconnectors-externalitem.md).

Примеры использования агрегатов для улучшения и снижения объема результатов поиска см. в разделе [Уточнение результатов поиска](/graph/search-concept-aggregation).

## <a name="request-spelling-correction"></a>Исправление орфографии в запросе

Исправление орфографии — популярный способ обработки несоответствий между опечатками в запросе пользователя и правильными словами в содержимом. При обнаружении опечаток в исходном пользовательском запросе вы можете получить результат поиска для исходного запроса пользователя или исправленной версии запроса. Вы также можете получить сведения об исправлении опечаток в свойстве **queryAlterationResponse** объекта [searchResponse](searchresponse.md).

В тексте запроса метода [query](/graph/api/search-query) укажите **queryAlterationOptions** для применения с целью исправления орфографии в запросе. Описание **queryAlterationOptions** определяется в [searchRequest](./searchrequest.md).

Примеры использования исправлений орфографии см. в разделе [Исправление орфографии в запросе](/graph/search-concept-speller).

## <a name="search-display-layout"></a>Макет отображения при поиске

API поиска позволяет отображать результаты поиска из [соединителей](/microsoftsearch/connectors-overview) при помощи макета отображения или шаблона результатов, настроенного ИТ-администратором для каждого соединителя. Шаблоны результатов — это [адаптивные карточки](https://adaptivecards.io/), которые являются семантически значимым сочетанием макета и данных.

Чтобы получить шаблон результатов в [searchResponse](searchresponse.md), присвойте свойству **enableResultTemplate** значение **true**, которое определяется в [resultTemplateOptions](./resulttemplateoption.md) в [searchRequest](./searchrequest.md). Отклик включает **resultTemplateId** для каждого объекта [searchHit](./searchhit.md), который сопоставляется с одним из макетов отображения, включенных в словарь **resultTemplates**, являющийся частью отклика.

Примеры отображения результатов поиска см. в разделе [Использование макета отображения при поиске](/graph/search-concept-display-layout).

## <a name="error-handling"></a>Обработка ошибок

API поиска возвращает отклики с ошибками, описанные в [определении объектов ошибок OData](http://docs.oasis-open.org/odata/odata-json-format/v4.01/cs01/odata-json-format-v4.01-cs01.html#sec_ErrorResponse), каждый из которых представляет собой объект JSON, содержащий код и сообщение.

<!---TODOSEARCHAPI Describe the know errors: bad requests.--->

## <a name="known-limitations"></a>Известные ограничения

На API поиска распространяются описанные ниже ограничения.

- Метод **query** определяется, чтобы разрешить передачу коллекции из одного или нескольких экземпляров **searchRequest**. Однако в настоящее время служба может обрабатывать только по одному экземпляру [searchRequest](./searchrequest.md) за раз.

- Ресурс [searchRequest](./searchrequest.md) поддерживает одновременную передачу объектов нескольких типов. Однако в настоящее время поддерживается только следующее сочетание для типов объектов SharePoint и OneDrive: **driveItem**, **drive**, **site**, **list**, **listItem**.
Любые сочетания, включающие **message**, **event**, типы SharePoint и OneDrive или **externalItem**, пока не поддерживаются.  

- Свойство **contentSource**, которое определяет используемое соединение, применимо, только если для свойства **entityType** задано значение `externalItem`.

- API поиска не поддерживает настраиваемую сортировку для **message**, **event** или **externalItem**.

- API поиска не поддерживает агрегаты для **message**, **event**, **site** или **drive**.

- Пользовательские настройки поиска SharePoint, например пользовательская схема поиска или источники поиска, могут влиять на работу API Поиска (Майкрософт).

## <a name="see-also"></a>См. также

- Подробнее о некоторых основных вариантах использования:
  - [Поиск сообщений Outlook](/graph/search-concept-messages)
  - [Поиск событий календаря](/graph/search-concept-events)
  - [Поиск содержимого в OneDrive и SharePoint](/graph/search-concept-files)
  - [Сортировка результатов поиска](/graph/search-concept-sort)
  - [Уточнение результатов поиска](/graph/search-concept-aggregation)
  - [Исправление орфографии в запросе](/graph/search-concept-speller)
  - [Использование макета отображения при поиске](/graph/search-concept-display-layout)

- Узнайте больше об API в [песочнице Graph](https://developer.microsoft.com/graph/graph-explorer).
- Узнайте о [новых функциях и обновлениях](/graph/whats-new-overview) для этого набора API.
