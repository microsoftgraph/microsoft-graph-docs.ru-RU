# <a name="get-started-with-microsoft-graph-and-rest"></a>Начало работы с Microsoft Graph и REST

В этой статье описываются задачи, которые необходимо выполнить, чтобы получить маркер доступа из конечной точки Azure AD версии 2.0 и вызвать Microsoft Graph с помощью вызовов REST. В ней описывается последовательность запросов и ответов, которую приложение использует для проверки подлинности и получения электронных сообщений.

Для начала необходимо зарегистрировать приложение в службе Azure Active Directory (Azure AD). 

## <a name="register-the-application"></a>Регистрация приложения

В настоящее время существует два способа регистрации приложения в Azure AD:

  - Регистрация приложения для использования конечной точки Azure AD версии 2.0, которая подходит как для личных удостоверений (учетных записей Майкрософт), так и для рабочих и учебных учетных записей (Azure AD).
  - Регистрация приложения для использования конечной точки Azure AD, которая поддерживает только рабочие и учебные учетные записи.

В этой статье рассматривается регистрация с помощью конечной точки версии 2.0, поэтому мы будем использовать [портал регистрации приложений](https://apps.dev.microsoft.com/). Чтобы зарегистрировать приложение, выполните действия, указанные в статье [Регистрация приложения Microsoft Graph с помощью конечной точки Azure AD версии 2.0](../concepts/auth_register_app_v2.md). Сведения об использовании конечной точки Azure AD см. в статье [Проверка подлинности с помощью Azure AD](../concepts/auth_v2_user.md).

> При использовании конечной точки версии 2.0 действуют некоторые ограничения. Сведения о том, как выбрать подходящий способ, см. в статье [Следует ли мне использовать конечную точку версии 2.0?](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-limitations/)

## <a name="authenticate-the-user-and-get-an-access-token"></a>Проверка подлинности пользователя и получение маркера доступа

В описанном здесь приложении реализован [поток предоставления кода авторизации](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-protocols-oauth-code/) для получения маркеров доступа из конечной точки Azure AD версии 2.0 в соответствии со стандартными [протоколами OAuth 2.0](http://tools.ietf.org/html/rfc6749). Полное руководство по потокам, поддерживаемым в конечной точке Azure AD версии 2.0, см. в статье [Типы конечной точки версии 2.0](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-flows/).

В потоке предоставления кода авторизации вы сначала получаете код авторизации, а затем обмениваете его на маркер доступа.

### <a name="getting-an-authorization-code"></a>Получение кода авторизации

Чтобы использовать поток предоставления кода авторизации, сначала необходимо получить код. Приложение получает код от сервера авторизации, когда пользователь выполняет вход и предоставляет приложению запрашиваемые разрешения.

Чтобы запросить код авторизации, необходимо отправить запрос GET конечной точке Azure AD версии 2.0. Этот URL-адрес нужно открыть в браузере, чтобы пользователь мог выполнить вход и предоставить требуемые разрешения.

#### <a name="construct-the-request"></a>Создание запроса

1. Начните с базового URL-адреса:

```
https://login.microsoftonline.com/{tenant}/oauth2/v2.0/authorize
```

сегмент *tenant* в пути указывает, кто может входить в приложение. Допустимые значения: *common*, *organizations*, *consumers* и идентификаторы клиентов. Дополнительные сведения см. в разделе [Endpoints](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-protocols/#endpoints).

2. Добавьте параметры запроса к базовому URL-адресу. Они используются для идентификации приложения, запрашиваемых разрешений и других данных запроса на проверку подлинности. В приведенной ниже таблице описываются некоторые распространенные параметры.

| Параметр | Описания |
|:------|:------|
| client_id | Идентификатор приложения, создаваемый при его регистрации. С его помощью Azure AD определяет приложения, которые запрашивают вход. |
| redirect_uri | Адрес, на который Azure перенаправит пользователя после того, как он разрешит приложению доступ. Это значение должно соответствовать значению **URI перенаправления**, которое использовалось при регистрации приложения. |
| response_type | Тип ответа, который ожидается приложением. Для потока предоставления кода авторизации используется значение `code`. |
| scope | Разделенный пробелами список [разрешений Microsoft Graph](./permissions_reference.md), запрашиваемых приложением. Вы также можете указать [области OpenId Connect](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-scopes/#openid-connect-scopes) для [единого входа](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-protocols-oidc/).  |
| state | Включенное в запрос значение, которое также возвращается в ответе с маркером и используется для проверки. |

Например, URL-адрес запроса для приложения, которому требуется доступ на чтение почты, может выглядеть так:

```
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=<app ID>&redirect_uri=http%3A%2F%2Flocalhost/myapp%2F&response_type=code&state=1234&scope=mail.read
```

3. Перенаправьте пользователя на страницу URL-адреса для входа. Отображается экран входа с названием приложения. После входа отображается список необходимых приложению разрешений, и пользователь может разрешить или запретить доступ. Если пользователь разрешил доступ, в браузере открывается URI перенаправления с кодом и состоянием авторизации в строке запроса, как показано в приведенном ниже примере.

```
http://localhost/myapp/?code=AwABAAAA...cZZ6IgAA&state=1234
```

Далее необходимо заменить возвращенный код авторизации на маркер доступа.

### <a name="getting-an-access-token"></a>Получение маркера доступа

Чтобы получить маркер доступа, приложение помещает параметры, закодированные с использованием формы, в URL-адрес запроса маркера (например, `https://login.microsoftonline.com/common/oauth2/v2.0/token`). При этом применяются указанные ниже параметры.

| Параметр | Описания |
|:------|:------|
| client_id | Идентификатор приложения, создаваемый при его регистрации. |
| client_secret | Секрет приложения, создаваемый при его регистрации. |
| code | Код авторизации, полученный на предыдущем этапе. |
| redirect_uri | Это значение должно совпадать со значением, используемым в запросе кода авторизации. |
| grant_type | Тип предоставления, используемый приложением. Для потока предоставления кода авторизации используется значение `code`. |
| scope | Разделенный пробелами список [разрешений Microsoft Graph](./permissions_reference.md), запрашиваемых приложением. |

URL-адрес запроса для нашего приложения с кодом, полученным на предыдущем этапе, выглядит так:

```
POST https://login.microsoftonline.com/common/oauth2/v2.0/token
Content-Type: application/x-www-form-urlencoded

{
  grant_type=authorization_code
  &code=AwABAAAA...cZZ6IgAA
  &redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
  &resource=https%3A%2F%2Fgraph.microsoft.com%2F
  &scope=mail.read
  &client\_id=<app ID>
  &client\_secret=<app SECRET>
}
```

Ответ сервера содержит полезные данные JSON, которые включают маркер доступа.

```
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8

{
  "token_type":"Bearer",
  "expires_in":"3600",
  "access_token":"eyJ0eXAi...b66LoPVA",
  "scope":"https://graph.microsoft.com/mail.read",
  ...
}
```

Токен доступа находится в поле `access_token` полезных данных JSON. С помощью этого значения приложение задает заголовок Authorization, когда выполняет вызовы REST к API.

## <a name="call-microsoft-graph"></a>Вызов Microsoft Graph

После получения маркера доступа приложение готово к вызову Microsoft Graph. Так как этот пример приложения получает сообщения, он будет использовать HTTP-запрос GET к конечной точке `https://graph.microsoft.com/v1.0/me/messages`.

### <a name="refine-the-request"></a>Уточнение запроса

Вы можете управлять запросами GET в приложении с помощью параметров запроса OData. Рекомендуем использовать эти параметры для ограничения числа возвращаемых результатов, а также полей, возвращаемых для каждого элемента. 

В этом приложении сообщения отображаются в таблице, где указаны тема, отправитель, дата и время получения сообщения. Таблица содержит не более 25 строк: сообщения сортируются по дате получения от новых к старым. Для получения таких результатов приложение использует следующие параметры запроса:

- `$select`: задает только поля `subject`, `sender` и `dateTimeReceived`.
- `$top`: задает до 25 элементов.
- `$orderby`: сортирует результаты по полю `dateTimeReceived`.

В результате мы получаем следующий запрос:

```
GET https://graph.microsoft.com/v1.0/me/messages?$select=subject,from,receivedDateTime&$top=25&$orderby=receivedDateTime%20DESC
Accept: application/json
Authorization: Bearer eyJ0eXAi...b66LoPVA
```

Теперь вы знаете, как вызывать Microsoft Graph, и можете создавать другие вызовы, необходимые для вашего приложения, используя справочник по API. Обратите внимание, что необходимые для вызовов разрешения настраиваются во время регистрации приложения.

## <a name="next-steps"></a>Дальнейшие действия
- Попробуйте другие возможности REST API, используя [песочницу Graph](https://graph.microsoft.io/graph-explorer).

## <a name="see-also"></a>См. также
- [Получение маркеров доступа для вызова Microsoft Graph](https://developer.microsoft.com/en-us/graph/docs/concepts/auth_overview)
- [Получение доступа от имени пользователя](https://developer.microsoft.com/en-us/graph/docs/concepts/auth_v2_user)
- [Получение доступа без пользователя](https://developer.microsoft.com/en-us/graph/docs/concepts/auth_v2_service)
