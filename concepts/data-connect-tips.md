---
title: Советы по использованию подключения к данным Microsoft Graph
description: Советы, помогающие воспользоваться преимуществами подключения к данным Microsoft Graph.
author: tlenig
localization_priority: Priority
ms.prod: data-connect
ms.openlocfilehash: d9a87c629a80bc94c57e77bd0f2c0b1e7438c935
ms.sourcegitcommit: d700b7e3b411e3226b5adf1f213539f05fe802e8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/19/2021
ms.locfileid: "52547606"
---
# <a name="tips-for-using-microsoft-graph-data-connect"></a>Советы по использованию подключения к данным Microsoft Graph

Подключение к данным Microsoft Graph позволяет разработчикам создавать приложения, которым пользователи смогут предоставлять управляемый доступ к масштабным наборам данных Microsoft Graph. Эта статья содержит советы, помогающие воспользоваться преимуществами функции подключения к данным. Для знакомства с подключением к данным Microsoft Graph см. статью [Обзор](data-connect-concept-overview.md).

## <a name="is-microsoft-graph-data-connect-right-for-you"></a>Подходит ли вам подключение к данным Microsoft Graph?

Подключение к данным и API Microsoft Graph обеспечивают доступ к одинаковым базовым данным, но очень разными способами. Подключение к данным предназначено для массового извлечения больших объемов данных, а API Microsoft Graph больше подходит для доступа к отдельным наборам данных в режиме реального времени. В некоторых случаях можно даже объединить их. Например, может потребоваться использовать подключение к данным, чтобы выполнить начальное извлечение данных электронной почты за последний год, а затем применить API Microsoft Graph для дальнейшего анализа писем в режиме реального времени. Подключение к данным и API Microsoft Graph — это разные средства для разных задач. Важно продумать, какой метод лучше подходит к вашему сценарию.

## <a name="expect-an-initial-overhead"></a>Ожидайте дополнительные затраты времени на начальном этапе 

Так как подключение к данным предназначено для массового извлечения больших объемов данных, возникают дополнительные затраты времени перед тем, как можно будет извлечь данные. Эти затраты составляют около 45 минут. Это означает, что этот период потребуется для всех конвейеров вне зависимости от размера данных. Этими затратами можно пренебречь для больших объемов данных, но если такой промежуток времени недопустим в вашем сценарии, API Microsoft Graph может обеспечить более подходящий способ.

## <a name="data-must-stay-within-the-organizations-subscription"></a>Данные должны оставаться в рамках подписки организации

Конвейеры подключения к данным управляются фабрикой данных Azure, являющейся службой интеграции данных, работающей в рамках подписки Azure. Подписка Azure [связана только с одним клиентом Microsoft 365](/azure/active-directory/fundamentals/active-directory-how-subscriptions-associated-directory). Таким образом, данные должны сначала направляться в связанную подписку Azure. После дальнейшей минимизации и агрегации данные можно использовать в другом месте.

Если нужно создать приложение для других пользователей, чтобы извлекать данные Microsoft 365, можно упаковать приложение как [управляемое приложение Azure](/azure/managed-applications/overview) и опубликовать его в Azure Marketplace. Затем другой пользователь сможет развернуть ваше приложение в своей подписке Azure, и приложение получит доступ к данным в клиенте. 

## <a name="use-of-service-principals"></a>Используйте субъекты-службы

При создании конвейера фабрики данных необходимо предоставить субъект-службу для связанной службы Microsoft 365. В Azure субъект-служба — это объект безопасности, представляющий приложение или службу (в отличие от пользователя). Подключение к данным использует этот субъект-службу в качестве удостоверения при получении авторизованного доступа к вашим данным Microsoft 365.
Если вы создаете управляемое приложение Azure для других пользователей с целью применения в клиентах, вам также нужно предоставить субъект-службу для использования приложением. Этот субъект-служба будет существовать в вашем клиенте (издателя). Но если приложению требуются другие субъекты-службы, пользователю (установщику) нужно будет создать их в собственном клиенте. Например, вашему конвейеру фабрики данных, скорее всего, потребуется доступ к ресурсу хранилища в Azure. Пользователю потребуется создать субъект-службу с разрешениями на доступ к учетной записи хранилища для использования конвейером.

## <a name="check-for-pending-privileged-access-management-requests"></a>Проверяйте ожидающие запросы управления привилегированным доступом

Прежде чем подключение к данным сможет скопировать ваши данные администратор должен утвердить запрос на управление привилегированным доступом (PAM). Управление привилегированным доступом — это механизм, используемый для разрешения доступа вашего конвейера данных к данным в Microsoft 365. При первом запуске конвейера ожидается утверждение запроса на доступ администратором Microsoft 365 (или назначенным делегатом). Хотя состояние конвейера отображается как **Выполняется**, базовому действию копирования будет соответствовать состояние **ConsentPending** до получения утверждения, как показано на снимке экрана ниже.

![Снимок экрана: область состояния работы конвейера с состоянием ConsentPending](images/data-connect-tips.png)

При разработке рекомендуется проверять, что канал не застрял в состоянии **ConsentPending**, особенно после внесения изменений в конвейер. Например, при добавлении дополнительного поля в схему следующий запуск конвейера приведет к созданию запроса PAM, требующего утверждения. Не теряйте время с конвейером, ожидающим вашего утверждения.

## <a name="approve-pam-requests-via-microsoft-365-admin-portal"></a>Утверждайте запросы PAM через портал администрирования Microsoft 365

В документации по подключению данных показано, как использовать PowerShell и пользовательский интерфейс PAM, чтобы утверждать запросы PAM. Для утверждения с помощью пользовательского интерфейса PAM откройте пользовательский интерфейс PAM на [портале администрирования Microsoft 365](https://admin.microsoft.com/Adminportal/Home?source=applauncher#/Settings/PrivilegedAccess). Портал предоставляет простой и понятный способ просмотра, утверждения, отклонения или отзыва запросов PAM. Ссылка на надстройку подключения к данным Microsoft Graph находится в разделе **Параметры** > **Службы и надстройки** > **Подключение к данным Microsoft Graph**.

## <a name="use-a-second-user-to-approve-pam-requests"></a>Используйте второго пользователя для утверждения запросов PAM

Если вы запускаете конвейер и запрос PAM, запрос вкладывается в вашу учетную запись, которой принадлежит субъект-служба, используемая конвейером. Но даже если эта учетная запись состоит в настроенной вами группе утверждающих, вы не сможете использовать ее для утверждения запроса PAM, так как самостоятельные утверждения не разрешаются. При попытке появится сообщение об ошибке в портале PAM: "Запрашивающий и утверждающий совпадают. Самостоятельное утверждение запрещено". При разработке рекомендуется использовать вторую учетную запись помимо администратора, утверждающего запросы. Как отправитель, так и утверждающий должны иметь активные учетные записи Exchange Online.

## <a name="deduplicate-emails-when-needed"></a>При необходимости выполняйте дедупликацию сообщений электронной почты

При извлечении сообщений электронной почты из набора данных `Message` часто создается несколько объектов JSON одного сообщения. Эти дубликаты существуют, так как при отправке сообщения нескольким пользователям создается его копия в почтовом ящике каждого получателя. Так как набор данных извлекается из каждого почтового ящика, он будет содержать все копии от разных пользователей. В некоторых случаях может требоваться сохранение всех копий, но в остальных случаях рекомендуется удалять дубликаты.
Выполнить дедупликацию экспортированных объектов JSON можно на основе параметра `internetMessageId` сообщений: два сообщения с одинаковым значением `internetMessageId` являются копиями одного экземпляра. Так как дубликаты могут существовать в разных BLOB-объектах, дедупликацию необходимо выполнять во всех BLOB-объектах, а не в отдельных BLOB-объектах.

## <a name="use-puser-field-to-determine-the-relevant-user"></a>Используйте поле puser, чтобы определить соответствующего пользователя

Извлеченные данные содержат некоторые свойства Meta, не существующие при использовании соответствующего API Microsoft Graph. В частности, поле `puser` может быть полезно для определения пользователя, данные о котором извлечены. В сценарии с двумя копиями одного сообщения электронной почты в разных почтовых ящиках вы можете использовать поле `puser`, чтобы определить, из какого почтового ящика получена каждая копия.
Поле `puser` также удобно применять для наборов данных, например для набора данных `Manager`. Экспортированные объекты JSON содержат сведения о руководителе, но они полезны, только если вы знаете, кем он руководит. Поле `puser` указывает, чей руководитель соответствует этому объекту JSON.

## <a name="next-steps"></a>Дальнейшие действия

Обратитесь на [форум идей платформы для разработчиков Microsoft 365](https://techcommunity.microsoft.com/t5/microsoft-365-developer-platform/idb-p/Microsoft365DeveloperPlatform/label-name/Microsoft%20Graph), чтобы запросить функции.