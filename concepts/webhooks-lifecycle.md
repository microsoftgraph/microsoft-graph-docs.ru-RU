---
title: Уменьшение количества пропущенных уведомлений о подписках и изменениях
description: У приложений, подписывающихся на уведомления об изменениях, могут быть удалены их подписки, что приводит к пропуску некоторых уведомлений об изменениях. В приложениях должна быть реализована логика определения потерь и восстановления после них, а также возобновления непрерывного потока уведомлений об изменениях.
author: davidmu1
ms.localizationpriority: high
ms.custom: graphiamtop20
ms.openlocfilehash: 519178ee7609d615c32c628721b3154853273422
ms.sourcegitcommit: 6c04234af08efce558e9bf926062b4686a84f1b2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/12/2021
ms.locfileid: "59108753"
---
# <a name="reduce-missing-subscriptions-and-change-notifications"></a>Уменьшение количества пропущенных уведомлений о подписках и изменениях

У приложений, подписывающихся на уведомления об изменениях, могут быть удалены их подписки, что приводит к пропуску некоторых уведомлений об изменениях. В приложениях должна быть реализована логика определения потерь и восстановления после них, а также возобновления непрерывного потока уведомлений об изменениях.

Некоторые события могут приводить к удалению подписки. Среди этих событий следующие:

- сброс пароля пользователя;
- устройство пользователя не соответствует требованиям;
-   учетная запись пользователя отозвана.

В случае такого события Microsoft Graph отправляет специальное уведомление жизненного цикла `subscriptionRemoved`.

Microsoft Graph также отправляет другое уведомление жизненного цикла `missed`, если уведомление об изменении не может быть доставлено в приложение.

Приложение, подписывающееся на уведомления об изменениях, должно прослушивать сигналы `subscriptionRemoved` и `missed`, и выполнить следующее:

- После получения уведомления жизненного цикла `subscriptionRemoved` приложение должно повторно создать подписку, чтобы поддерживать непрерывный поток.
- При получении уведомления жизненного цикла `missed` приложение должно повторно синхронизировать данные ресурсов с помощью Microsoft Graph.

Чтобы получать уведомления жизненного цикла, можно использовать существующую конечную точку **notificationUrl**, которая уже получает уведомления об изменениях, или можно зарегистрировать отдельное свойство **lifecycleNotificationUrl** для получения уведомлений жизненного цикла `subscriptionRemoved` и `missed` в отдельной конечной точке.

Уведомления жизненного цикла поддерживаются для подписок, созданных в следующих типах ресурсов:

- [Сообщение][] Outlook
- [Событие][] Outlook
- Личный [контакт][] Outlook
- [chatMessage][] Teams

Для других типов ресурсов вы по-прежнему можете указать `lifecycleNotificationUrl` при создании подписки, и ваше приложение будет получать уведомления жизненного цикла при применении их ресурсом.

## <a name="creating-a-subscription"></a>Создание подписки

При создании подписки необходимо указать отдельную конечную точку уведомлений с помощью свойства **lifecycleNotificationUrl**. Если указана конечная точка, все текущие и будущие типы уведомлений жизненного цикла будут доставляться в нее. В противном случае уведомления жизненного цикла `subscriptionRemoved` и `missed` доставляться не будут. Эта конечная точка может совпадать с **notificationUrl**.

### <a name="subscription-request-example"></a>Пример запроса на подписку

```http
POST https://graph.microsoft.com/v1.0/subscriptions
Content-Type: application/json

{
  "changeType": "created,updated",
  "notificationUrl": "https://webhook.azurewebsites.net/api/resourceNotifications",
  "lifecycleNotificationUrl": "https://webhook.azurewebsites.net/api/lifecycleNotifications",
  "resource": "/users/{id}/messages",
  "expirationDateTime": "2020-03-20T11:00:00.0000000Z",
  "clientState": "<secretClientState>"
}
```
 
> [!IMPORTANT]
> Используйте одинаковое имя узла (FQDN) для обоих URL-адресов уведомлений. 

Вам нужно проверить обе конечные точки, как описано в статье [Управление подписками](webhooks.md#managing-subscriptions). Если вы решили использовать один URL-адрес для обеих конечных точек, вы получите два запроса на проверку с необходимостью ответа на них.

> **Примечание.** Вы не сможете обновить (`PATCH`) существующие подписки, чтобы добавить свойство **lifecycleNotificationUrl**. Следует удалить такие существующие подписки, создать новые подписки и указать свойство **lifecycleNotificationUrl**. Существующие подписки без свойства **lifecycleNotificationUrl** не будут получать уведомления `subscriptionRemoved` и `missed`.

## <a name="responding-to-subscriptionremoved-notifications"></a>Ответ на уведомления subscriptionRemoved

Уведомление жизненного цикла `subscriptionRemoved` информирует, что подписка была удалена и следует создать ее заново, если вы хотите продолжать получение уведомлений об изменениях. 

Вы можете создавать длительные подписки (на 3 дня), а уведомления об изменениях начнут поступать в **notificationUrl**. Однако условия доступа к данным ресурса могут со временем измениться. Например, в службе может произойти событие, требующее от приложения повторной проверки подлинности пользователя. В таком случае поток выглядит следующим образом:

1. Служба определяет, что подписка должна быть удалена из Microsoft Graph.
    
    Для этих событий отсутствует заданная периодичность. Для одних ресурсов они могут происходить часто, а для других — практически никогда.

2. Microsoft Graph отправляет уведомление жизненного цикла `subscriptionRemoved` для **lifecycleNotificationUrl** (если указано).  

3. Вы можете ответить на это уведомление жизненного цикла, создав новую подписку для того же ресурса. Для этого нужно представить допустимый маркер доступа; в некоторых случаях это означает, что приложению необходимо выполнить повторную проверку подлинности пользователя, чтобы получить новый допустимый маркер доступа.

4. Если вы успешно создали новую подписку, возобновится поток уведомлений об изменениях. Но если вам не удалось это сделать (например, приложение не может получить допустимый маркер доступа), уведомления об изменениях не отправляются.

5. Создав новую подписку, вы можете синхронизировать данные ресурсов, чтобы выявить все отсутствующие изменения.

### <a name="subscriptionremoved-notification-example"></a>Пример уведомления subscriptionRemoved

```json
{
  "value": [
    {
      "subscriptionId":"<subscription_guid>",
      "subscriptionExpirationDateTime":"2019-03-20T11:00:00.0000000Z",
      "tenantId": "<tenant_guid>",
      "clientState":"<secretClientState>",
      "lifecycleEvent": "subscriptionRemoved"
    }
  ]
}
```

Обратите внимание на следующие моменты для этого типа уведомления.

- Поле `"lifecycleEvent": "subscriptionRemoved"` определяет это уведомление, как связанное с удалением подписки. Также возможны другие типы уведомлений жизненного цикла. В будущем будут добавлены новые типы.
- Это уведомление жизненного цикла не содержит никаких сведений о конкретном ресурсе, так как оно связано не с изменением ресурса, а с изменением состояния подписки.
- Как и уведомления об изменениях, уведомления жизненного цикла могут объединяться (в массиве **value**), каждое с возможно разными значениями **lifecycleEvent**. Обрабатывайте каждое уведомление жизненного цикла в пакете соответствующим образом.

> **Примечание.** Полное описание данных, отправленных при доставке уведомлений об изменениях, см. в [changeNotificationCollection](/graph/api/resources/changenotificationcollection).

### <a name="actions-to-take"></a>Выполняемые действия

1. [Подтвердите](webhooks.md#change-notifications) получение уведомления жизненного цикла, ответив на вызов POST с помощью `202 - Accepted`.
2. [Проверьте](webhooks.md#change-notifications) подлинность уведомления жизненного цикла.
3. Убедитесь, что у приложения есть допустимый маркер доступа для выполнения следующего действия. 
  > **Примечание.** Если вы используете одну из [библиотек проверки подлинности](/azure/active-directory/develop/reference-v2-libraries), они сделают это за вас, повторно использовав допустимый кэшированный маркер или получив новый маркер, а также попросив пользователя войти еще раз (с помощью нового пароля). Обратите внимание, что получение нового маркера может завершиться сбоем, так как условия доступа могли измениться, и вызывающей стороне больше недоступны данные ресурсов.

4. Создайте новую подписку с помощью стандартного процесса, описанного [здесь](webhooks.md#subscription-request-example).

  > **Примечание.** Это действие может завершиться сбоем, так как проверки авторизации, выполняемые системой, могут отказать приложению или пользователю в доступе к ресурсу. Приложению может потребоваться получение нового маркера доступа от пользователя для повторной авторизации подписки. Вы можете повторить эти действия позднее в любое время, например, когда изменятся условия доступа. Все изменения ресурсов с момента отправки уведомления жизненного цикла до успешного воссоздания подписки приложением будут потеряны. Приложению потребуется получить эти изменения самостоятельно.

5. После создания новой подписки синхронизируйте все отсутствующие данные ресурсов с последнего известного момента получения уведомления об изменении для этого ресурса. Например: `GET https://graph.microsoft.com/v1.0/users/{id}/messages?$filter=createdDateTime+ge+{LastTimeNotificationWasReceived}`

## <a name="responding-to-missed-notifications"></a>Реагирование на пропущенные уведомления

Эти сигналы сообщают, что некоторые уведомления об изменениях могли быть не доставлены. Вам следует решить, пропустить или обработать эти сигналы.

### <a name="notification-example"></a>Пример уведомления

```json
{
  "value": [
    {
      "subscriptionId":"<subscription_guid>",
      "subscriptionExpirationDateTime":"2019-03-20T11:00:00.0000000Z",
      "tenantId": "<tenant_guid>",
      "clientState":"<secretClientState>",
      "lifecycleEvent": "missed"
    }
  ]
}
```

Обратите внимание на следующие моменты для этого типа уведомления.

- Поле `"lifecycleEvent": "missed"` определяет это в качестве сигнала о пропущенных уведомлениях об изменениях. Также возможны другие типы уведомлений жизненного цикла. В будущем будут добавлены новые типы.
- Это уведомление жизненного цикла не содержит никаких сведений о конкретном ресурсе, так как оно связано не с изменением ресурса, а с изменением состояния подписки.
- Как и уведомления об изменениях, уведомления жизненного цикла могут объединяться (в массиве **value**), каждое с возможно разными значениями **lifecycleEvent**. Обрабатывайте каждое уведомление жизненного цикла в пакете соответствующим образом.

> **Примечание.** Полное описание данных, отправленных при доставке уведомлений об изменениях, см. в [changeNotificationCollection](/graph/api/resources/changenotificationcollection).

### <a name="actions-to-take"></a>Выполняемые действия

1. [Подтвердите](webhooks.md#change-notifications) получение уведомления жизненного цикла, ответив на вызов POST с помощью `202 - Accepted`.
    - Если вы игнорируете эти сигналы, не выполняйте других действий. В противном случае:
2. [Проверьте](webhooks.md#change-notifications) подлинность уведомления жизненного цикла.
3. Выполните полную повторную синхронизацию данных ресурса для выявления изменений, не доставленных в качестве уведомлений. 

## <a name="responding-to-reauthorizationrequired-notifications"></a>Реагирование на уведомления reauthorizationRequired

Получив уведомление о жизненном цикле `reauthorizationRequired`, необходимо выполнить повторную авторизацию подписки, чтобы поток данных не прекращался.

Вы можете создавать длительные подписки (на 3 дня), таким образом уведомления об изменениях начнут поступать в **notificationUrl**. В случае изменений в условия доступа Microsoft Graph может потребовать повторную авторизацию подписки, чтобы подтвердить наличие у вас доступа к данным ресурсов. Ниже приведены примеры изменений, влияющих на доступ к данным.

- Администратор клиента может отозвать разрешения приложения на чтение ресурса.
- В интерактивном сценарии к пользователю, предоставляющему маркер проверки подлинности для вашего приложения, могут применяться динамические политики на основе различных факторов, например их расположения, состояния устройства или оценки риска. Например, если пользователь изменяет свое физическое расположение, ему может быть запрещен доступ к данным, и ваше приложение не сможет повторно авторизовать подписку. Дополнительные сведения о динамических политиках, управляющих доступом, см. в статье [Политики условного доступа Azure AD](/azure/active-directory/conditional-access/overview). 

Ниже указаны шаги, которые представляют собой поток запроса авторизации для активной подписки.

1. Microsoft Graph требует повторной авторизации подписки.
    
    Причины этого могут отличаться для разных ресурсов и меняться со временем. Необходимо ответить на событие повторной авторизации независимо от его причины.

2. Microsoft Graph отправляет уведомление о запросе авторизации в **lifecycleNotificationUrl**

    Обратите внимание, что поток уведомлений об изменениях может некоторое время продолжаться, предоставляя вам дополнительное время для ответа. Однако в конечном итоге доставка уведомлений об изменениях приостанавливается, пока вы не выполните требуемое действие.

3. Ответьте на это уведомление жизненного цикла одним из указанных ниже двух способов.
    - Проведите повторную авторизацию подписки. Это действие не продлит срок ее действия.
    - Возобновите подписку. Это действие одновременно повторно авторизует и продлит срок действия подписки.

    Примечание. Оба действия требуют предоставление действительного маркера проверки подлинности по аналогии с [созданием новой подписки](webhooks.md#creating-a-subscription) или [продлением подписки до истечения срока ее действия](webhooks.md#renewing-a-subscription).

4. Если вы выполните повторную авторизацию или возобновление подписки, то поступление уведомлений об изменениях продолжится. Если же вы этого не сделаете, то уведомления об изменениях по-прежнему не будут поступать.

### <a name="reauthorizationrequired-notification-example"></a>Пример уведомления reauthorizationRequired

```json
{
  "value": [
    {
      "lifecycleEvent": "reauthorizationRequired",
      "subscriptionId": "e3898f08-5cd0-4a6a-80fc-6addbfb73b7b",
      "subscriptionExpirationDateTime": "2019-09-18T00:52:45.9696658+00:00",
      "clientState": "{secret client state}",
      "tenantId": "84bd8158-6d4d-4958-8b9f-9d6445542f95"
    }
  ]
}
```

Обратите внимание на указанные ниже моменты для этого типа уведомления.

- Поле `"lifecycleEvent": "reauthorizationRequired"` назначает это уведомление запросом на авторизацию. Также возможны другие типы уведомлений жизненного цикла. В будущем будут добавлены новые типы.
- Это уведомление жизненного цикла не содержит никаких сведений о конкретном ресурсе, так как оно связано не с изменением ресурса, а с изменением состояния подписки.
- Как и уведомления об изменениях, уведомления жизненного цикла можно объединять (в коллекции **value**), каждое с возможно разными значениями **lifecycleEvent**. Обрабатывайте каждое уведомление жизненного цикла в пакете соответствующим образом.

> **Примечание.** Полное описание данных, отправленных при доставке уведомлений об изменениях, см. в [changeNotificationCollection](/graph/api/resources/changenotificationcollection).

### <a name="actions-to-take"></a>Выполняемые действия

1. [Подтвердите](webhooks.md#change-notifications) получение уведомления жизненного цикла, ответив на вызов POST с помощью `202 - Accepted`.
2. [Проверьте](webhooks.md#change-notifications) подлинность уведомления жизненного цикла.
3. Убедитесь, что у приложения есть допустимый маркер доступа для выполнения следующего действия. 
  > **Примечание.** Если вы используете одну из [библиотек проверки подлинности](/azure/active-directory/develop/reference-v2-libraries), они сделают это за вас, повторно использовав допустимый кэшированный маркер или получив новый маркер, а также попросив пользователя войти еще раз (с помощью нового пароля). Обратите внимание, что получение нового маркера может завершиться сбоем, так как условия доступа могли измениться, и вызывающей стороне больше недоступны данные ресурсов.

4. Вызовите один из двух следующих API. Если вызов API выполняется успешно, поток уведомлений об изменениях возобновляется.

    - Чтобы повторно авторизовать подписку без продления ее срока, вызовите действие `/reauthorize`:
        ```http
        POST  https://graph.microsoft.com/beta/subscriptions/{id}/reauthorize
        Content-type: application/json
        ```
    - Чтобы одновременно возобновить и повторно авторизовать подписку, выполните обычное действие возобновления:
        ```http
        PATCH https://graph.microsoft.com/beta/subscriptions/{id}
        Content-Type: application/json

        {
           "expirationDateTime": "2019-09-21T11:00:00.0000000Z"
        }
        ```

      Возобновление может завершиться сбоем, так как проверки авторизации, выполняемые системой, могут отказать приложению или пользователю в доступе к ресурсу. Приложению может потребоваться получение нового маркера доступа от пользователя для повторной авторизации подписки. 
      
      Вы может повторить эти действия позднее в любое время и успешно выполнить их, если изменяются условия доступа. Все уведомления об изменении ресурсов с момента отправки уведомления жизненного цикла до успешного воссоздания подписки приложением будут потеряны. В таких случаях приложению нужно отдельно получить эти изменения.

### <a name="additional-information"></a>Дополнительные сведения

Ниже приведены сведения, которые помогут разобраться с проблемами авторизации.

- Запросы авторизации не отменяют необходимость возобновления подписки на изменения ресурса до истечения ее срока действия. 

    Хотя вы можете возобновить подписку при получении запроса авторизации, Microsoft Graph может не выполнять запрос для всех ваших подписок. Например, подписка без действий и уведомлений об изменениях, ожидающих доставки, может не создавать для приложения запросы на повторную авторизацию. Обязательно [возобновите подписки](webhooks.md#renewing-a-subscription) до истечения их сроков действия.

- Частота запросов авторизации может изменяться.

    Не делайте предположений о частоте запросов авторизации. Эти уведомления жизненного цикла сообщают, когда нужно принимать действия, избавляя от отслеживания подписок, которым требуется повторная авторизация. Будьте готовы обрабатывать запросы авторизации каждые несколько минут для всех подписок или в редких случаях лишь для некоторых своих подписок.

## <a name="future-proof-the-code-handling-lifecycle-notifications"></a>Готовый к изменениям код обработки уведомлений жизненного цикла

В будущем в Microsoft Graph будут добавлены другие типы уведомлений жизненного цикла подписки. Они будут публиковаться в той же конечной точке: **lifecycleNotificationUrl**, но у них будет другое значение для **lifecycleEvent**, и они могут содержать немного другую схему и свойства, относящиеся к сценарию, для которого они создаются.

Необходимо предусматривать будущие изменения при внедрении своего кода, чтобы исключить его прерывание при введении новых типов уведомлений жизненного цикла в Microsoft Graph. Рекомендуется следующий подход:

1. Явным образом определите каждое уведомление жизненного цикла как поддерживаемое событие с помощью свойства **lifecycleEvent**. Например, найдите свойство `"lifecycleEvent": "subscriptionRemoved"` для определения конкретного события и обработайте его.

2. Просматривайте объявления об уведомлениях жизненного цикла для новых сценариев, так как в будущем могут быть представлены дополнительные типы уведомлений жизненного цикла.

3. В своем приложении игнорируйте любые уведомления жизненного цикла, не распознаваемые приложением, и заносите их в журнал для ознакомления.

4. По своему усмотрению просматривайте соответствующую документацию о новых уведомлениях жизненного цикла и реализуйте для них нужную поддержку.

## <a name="see-also"></a>См. также

- [Тип ресурса subscription](/graph/api/resources/subscription?view=graph-rest-1.0)
- [Получение подписки](/graph/api/subscription-get?view=graph-rest-1.0)
- [Создание подписки](/graph/api/subscription-post-subscriptions?view=graph-rest-1.0)
- [Удаление подписки](/graph/api/subscription-delete?view=graph-rest-1.0)
- [Обновление подписки](/graph/api/subscription-update?view=graph-rest-1.0)


[contact]: /graph/api/resources/contact?view=graph-rest-1.0
[event]: /graph/api/resources/event?view=graph-rest-1.0
[message]: /graph/api/resources/message?view=graph-rest-1.0
[chatMessage]: /graph/api/resources/chatmessage
