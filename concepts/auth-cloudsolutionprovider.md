---
title: Вызов Microsoft Graph из приложения CSP
description: В этом разделе описано, как предоставить приложению доступ к данным клиентов, управляемым партнером, через Microsoft Graph, используя поток предоставления кодов авторизации или поток клиентских учетных данных между службами.
author: jackson-woods
ms.localizationpriority: high
ms.prod: applications
ms.custom: graphiamtop20
ms.openlocfilehash: 8c610b1d795045c49b469ceb906a9994a4020b3a
ms.sourcegitcommit: 6c04234af08efce558e9bf926062b4686a84f1b2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/12/2021
ms.locfileid: "59021395"
---
# <a name="call-microsoft-graph-from-a-cloud-solution-provider-application"></a>Вызов Microsoft Graph из приложения CSP

> **Примечание.** Эта статья предназначена **только** для разработчиков приложений CSP. Программа [Поставщик облачных решений (Майкрософт) (CSP)](https://partner.microsoft.com/cloud-solution-provider) позволяет партнерам Майкрософт перепродавать веб-службы Майкрософт клиентам и управлять ими.

В этой статье описано, как обеспечить доступ приложения к данным пользователей, управляемым партнером, через Microsoft Graph с помощью [потока предоставления кодов авторизации](/azure/active-directory/develop/active-directory-protocols-oauth-code) или [потока клиентских учетных данных между службами](/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service).

**Важно!** Вызов Microsoft Graph из приложения CSP поддерживается только для ресурсов каталога (таких как **user**, **group**, **device**, **organization**) и ресурсов [Intune](/graph/api/resources/intune-graph-overview?view=graph-rest-beta).

## <a name="what-is-a-partner-managed-application"></a>Приложение, управляемое партнером

Программа "Поставщик облачных решений (Майкрософт)" позволяет партнерам Майкрософт перепродавать веб-службы Майкрософт (такие как Microsoft 365, Microsoft Azure и CRM Online) клиентам и управлять ими. Управление службами клиента осуществляется с помощью делегированных полномочий администратора, которые позволяют агентам партнера настраивать среды клиентов.

Кроме того, партнер-разработчик может создать **приложение, управляемое партнером**, для управления службами Майкрософт клиента. Приложения, управляемые партнером, часто называются приложениями *с предварительным доступом*, так как этим приложениям автоматически предоставляется доступ к данным всех клиентов. При работе с ними пользователю из одного из доменов клиента не нужно давать согласие на доступ к данным. Приложения, управляемые партнерами, также наследуют делегированные права администратора, поэтому агенты партнера также могут получить привилегированный доступ к клиентам через такое приложение.

## <a name="how-to-set-up-a-partner-managed-application"></a>Настройка приложения, управляемого партнером

Считается, что приложение *управляется партнером*, если ему предоставлены расширенные разрешения на доступ к данным пользователя.

> **Примечание.** Приложения, управляемые партнером, можно настроить *только* на уровне доменов Партнера. Для управления ресурсами домена клиента приложения, управляемые партнером, **необходимо** настроить как **мультитенантные**.

### <a name="register-and-configure-a-multi-tenant-app"></a>Регистрация и настройка мультитенантного приложения

Описанные здесь первые шаги похожи на большинство аналогичных действий по регистрации и настройке мультитенантного приложения.

1. [Зарегистрируйте приложение](/azure/active-directory/active-directory-app-registration) в домене Партнера на [портале Azure](https://portal.azure.com). Настройте приложение как [мультитенантное](/azure/active-directory/develop/active-directory-devhowto-multi-tenant-overview#update-registration-to-be-multi-tenant), чтобы партнер мог им управлять. Если приложение развернуто и продается в нескольких географических регионах, его нужно зарегистрировать в каждом из них, как описано <a href="#region">здесь</a>.
2. Настройте мультитенантное приложение еще раз на портале Azure, указав *необходимые разрешения* и используя способ, предусматривающий минимальные привилегии.

### <a name="pre-consent-your-app-for-all-your-customers"></a>Предоставление приложению доступа к данным всех клиентов

Предоставьте приложению, управляемому партнером, настроенные разрешения для доступа к данным всех ваших клиентов. Для этого добавьте атрибут **servicePrincipal**, представляющий приложение, в группу *Adminagents* в домене Партнера, используя PowerShell Azure AD версии 2. Скачать и установить PowerShell Azure AD версии 2 можно [здесь](https://www.powershellgallery.com/packages/AzureAD).  Выполните указанные ниже шаги, чтобы найти группу *Adminagents*, и добавьте в нее атрибут **servicePrincipal**.

1. Откройте сеанс PowerShell и подключитесь к клиенту партнера, введя учетные данные администратора в окне входа.

    ```PowerShell
    Connect-AzureAd
    ```

2. Найдите группу *Adminagents*.

    ```PowerShell
    $group = Get-AzureADGroup -Filter "displayName eq 'Adminagents'"
    ```

3. Найдите субъект-службу с тем же, *appId*, что и у приложения.

    ```PowerShell
    $sp = Get-AzureADServicePrincipal -Filter "appId eq '{yourAppsAppId}'"
    ```

4. Добавьте субъект-службу в группу *Adminagents*.

    ```PowerShell
    Add-AzureADGroupMember -ObjectId $group.ObjectId -RefObjectId $sp.ObjectId
    ```

## <a name="token-acquisition-flows"></a>Потоки получения маркеров

Потоки получения токенов для приложений, управляемых партнерами, ничем не отличаются от таковых для обычных мультитенантных приложений. Доступны [поток предоставления кодов авторизации](/azure/active-directory/develop/active-directory-protocols-oauth-code) и [поток учетных данных клиентов между службами](/azure/active-directory/develop/active-directory-protocols-oauth-service-to-service).

Помимо предварительного доступа ко всем доменам клиента, приложения, управляемые партнерами, имеют одну дополнительную возможность. С помощью таких приложений агенты могут получать доступ к данным доменов клиентов (используя делегированные права администратора). Принцип работы изложен ниже.

1. Агент выполняет вход в приложение с учетными данными пользователя, полученными от клиента партнера.
2. Приложение запрашивает маркер доступа для нужного клиента, управляемого партнером.
3. Приложение использует маркер доступа для вызова Microsoft Graph.

Это стандартный [поток предоставления кодов авторизации](/azure/active-directory/develop/active-directory-protocols-oauth-code), но агенты должны входить в свои учетные записи партнеров. Рассмотрим, как это выглядит на практике. Допустим, домен партнера — *partner.com* (домашний домен агентов), а домен клиента — *customer.com*:

1. [Получите код авторизации.](/azure/active-directory/develop/active-directory-protocols-oauth-code#request-an-authorization-code) Приложение отправляет запрос в конечную точку ```/authorize``` и должно использовать **домен клиента** (в нашем примере — ```customer.com```) в качестве целевого. Ваши агенты по-прежнему смогут входить в учетную запись ```username@partner.com```.

    ```http
    GET https://login.microsoftonline.com/customer.com/oauth2/authorize
    ```

2. [Получите маркер доступа, используя код авторизации.](/azure/active-directory/develop/active-directory-protocols-oauth-code#use-the-authorization-code-to-request-an-access-token) Отправляя запрос в конечную точку ```token```, приложение должно использовать **домен клиента** в качестве целевого домена, в нашем примере это ```customer.com```:

    ```http
    POST https://login.microsoftonline.com/customer.com/oauth2/token
    ```

3. Теперь, когда у вас есть маркер доступа, вызовем Microsoft Graph, поместив маркер доступа в заголовок авторизации HTTP:

    ```http
    GET https://graph.microsoft.com/beta/users
    Authorization: Bearer <token>
    ```

## <a name="register-your-app-in-the-regions-you-support"></a>Регистрация приложения в доступных регионах
<a name="region"></a>

В настоящее время взаимодействие с клиентами в рамках программы CSP ограничено одним регионом. В отношении управляемых партнерами приложений действует такое же ограничение. Это означает, что для каждого региона, где вы осуществляете продажи, нужен отдельный домен. Например, если ваше приложение, управляемое партнером, зарегистрировано в домене в США, а ваш клиент находится в ЕС, такое приложение работать не будет.  Каждый региональный домен партнера должен содержать собственный набор приложений, управляемых партнерами, для управления клиентами в том же регионе. При этом в приложение необходимо включить дополнительную логику, которая будет решать (до входа), какой региональный идентификатор приложения, управляемого партнером, показывать пользователю на основе имени для входа.

## <a name="calling-microsoft-graph-immediately-after-customer-creation"></a>Вызов Microsoft Graph сразу же после создания пользователя

При создании нового клиента с помощью [API Центра партнеров](https://partnercenter.microsoft.com/partner/developer) создается новый домен. Кроме того, создается отношение партнеров — вы становитесь партнером для этого нового домена клиента. Передача этого отношения в новый домен клиента может занять до 3 минут. Если приложение вызовет Microsoft Graph сразу после создания, ему, скорее всего, будет отказано в доступе. Аналогичная задержка может возникать после принятия вашего приглашения существующим клиентом. Это связано с тем, что предварительное предоставление доступа зависит от наличия отношения партнеров в домене клиента.

Во избежание этой проблемы рекомендуем сделать так, чтобы партнерское приложение вызывало Azure AD для получения маркера (требуется при вызове Microsoft Graph) только через **три минуты** после создания пользователя. В большинстве случаев этого будет достаточно. Но если через три минуты снова появится ошибка авторизации, подождите еще 60 секунд и попробуйте еще раз.

> **Примечание.** Перед повторным вызовом Microsoft Graph нужно получить новый маркер доступа из Azure AD.  Вызвать Microsoft Graph с помощью имеющегося маркера доступа не получится, так как маркер доступа действует в течение часа и не будет содержать утверждений о предоставленном доступе.
