---
title: Настройка уведомлений об изменениях в пользовательских данных
description: API Microsoft Graph использует механизм веб-перехватчиков для доставки уведомлений об изменениях для клиентов. Клиент — это веб-служба, которая настраивает свой URL-адрес для получения уведомлений об изменениях. С помощью этих уведомлений клиентские приложения обновляют свое состояние в случае изменений.
author: davidmu1
ms.prod: non-product-specific
localization_priority: Priority
ms.custom: graphiamtop20
ms.openlocfilehash: 5f25acf793d2b8bda00e298665ae8f9766f410b4
ms.sourcegitcommit: 3873c85f53e026073addca92d31d234af244444c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/10/2021
ms.locfileid: "53366886"
---
# <a name="set-up-notifications-for-changes-in-user-data"></a>Настройка уведомлений об изменениях в пользовательских данных

API Microsoft Graph использует механизм веб-перехватчиков для доставки уведомлений об изменениях для клиентов. Клиент — это веб-служба, которая настраивает свой URL-адрес для получения уведомлений об изменениях. С помощью этих уведомлений клиентские приложения обновляют свое состояние в случае изменений.

Приняв запрос на подписку, Microsoft Graph отправляет уведомления об изменениях на URL-адрес, указанный в подписке. Затем приложение действует в соответствии с бизнес-логикой. Например, оно получает дополнительные данные, обновляет кэш и представления, а также выполняет другие действия.


> [!VIDEO https://www.youtube-nocookie.com/embed/rC1bunenaq4]
 
> [!div class="nextstepaction"]
> [Руководство: Использование уведомлений об изменениях и функции отслеживания изменений в Microsoft Graph](/learn/modules/msgraph-changenotifications-trackchanges)

По умолчанию уведомления об изменениях не включают данные ресурсов, кроме `id`. Если приложению требуются данные ресурса, оно может вызвать API Microsoft Graph, чтобы получить ресурс полностью. В этой статье описывается работа с уведомлениями об изменениях на примере ресурса **user**.

Приложение также может подписаться на уведомления об изменениях, включающие данные ресурсов, чтобы избежать необходимости дополнительного вызова API для доступа к данным. В этом случае приложению необходимо реализовать дополнительный код для обработки требований таких уведомлений, в частности, ответа на уведомления о жизненном цикле подписки, проверки подлинности уведомлений и расшифровки данных ресурсов. Дополнительные сведения о работе с такими уведомлениями см. в статье [Настройка уведомлений об изменениях, включающих данные ресурсов](webhooks-with-resource-data.md).

## <a name="supported-resources"></a>Поддерживаемые ресурсы

С помощью API Microsoft Graph приложение может подписаться на изменения для следующих ресурсов:

- Облачная печать [printer][]
- Облачная печать [printTaskDefinition][]
- Контент внутри иерархии _любой папки_ [driveItem][] на персональном хранилище OneDrive пользователя
- Контент внутри иерархии _корневой папки_ [driveItem][] на персональном хранилище OneDrive для бизнеса
- [group][]
- Групповой [чат][] Microsoft 365 
- [Событие][] Outlook
- [Сообщение][] Outlook
- Личный [контакт][] Outlook
- [Оповещение][] безопасности
- [Список][] SharePoint
- [callRecord][] в Teams
- [Канал][] Teams 
- [Чат][] Teams
- [chatMessage][] Teams
- [conversationMember][] в Teams
- [Присутствие][] в Teams (предварительная версия)
- [Команда][] Teams
- [todoTask][] (предварительная версия)
- [пользователь][]

Вы можете создать подписку на определенную папку Outlook, например, папку Входящие: `me/mailFolders('inbox')/messages`

либо на ресурс верхнего уровня: `/me/messages`, `/me/contacts`, `/me/events`, `users`, `groups`, `/communications/callRecords`

либо на определенный экземпляр ресурса: `users/{id}`, `groups/{id}`, `groups/{id}/conversations`, `sites/{site-id}/lists/{list-id}`, `/communications/presences/{id}`

либо на личное хранилище OneDrive пользователя: `/drives/{id}/root`
`/drives/{id}/root/subfolder`.

либо на корневую папку диска SharePoint/OneDrive для бизнеса: `/drive/root`

либо на новое оповещение [API безопасности](security-concept-overview.md): `/security/alerts?$filter=status eq 'newAlert'`, `/security/alerts?$filter=vendorInformation/provider eq 'ASC'`

либо на задачи в списке дел пользователя: `/me/todo/lists/{todoTaskListId}/tasks`

### <a name="azure-ad-resource-limitations"></a>Ограничения ресурсов Azure AD

К ресурсам Azure AD (пользователи, группы) применяются определенные ограничения. В случае их превышения возникают ошибки.

> **Примечание**. Эти ограничения не применяются к ресурсам служб, не относящихся к Azure AD. Например, приложение может создать больше дополнительных подписок на ресурсы `message` или `event`, поддерживаемые службой Exchange Online в составе Microsoft Graph.

- Квоты максимальной подписки:

  - На приложение (для сочетания всех клиентов): 50 000 подписок всего
  - На клиента (для сочетания всех приложений): 1000 подписок всего во всех приложениях
  - На сочетание приложения и клиента: 100 подписок всего

Если какое-либо ограничение превышено, попытки создать подписку приведут к [ответу с ошибкой](errors.md) - `403 Forbidden`. Свойство `message` указывает, какое ограничение превышено.

- Клиенты Azure AD B2C не поддерживаются.

- Уведомления об изменениях для сущностей пользователей не поддерживаются для личных учетных записей Майкрософт.

- В подписках пользователей и групп существует [известная проблема](known-issues.md#change-notifications).

### <a name="outlook-resource-limitations"></a>Ограничения ресурсов Outlook

Если вы используете *имя участника-пользователя* на пути к ресурсу при оформлении подписки на ресурсы Outlook, например **сообщения**, **события** или **контакты**, запрос на подписку может быть не выполнен, если это имя содержит апостроф.  Используйте ИД GUID пользователей вместо имен участников-пользователей, чтобы избежать этой проблемы. Например, вместо пути к ресурсу:

`/users/sh.o'neal@contoso.com/messages`

Используйте:

`/users/{guid-user-id}/messages`

Доступно не более 1000 активных подписок на почтовый ящик для всех приложений.

### <a name="teams-resource-limitations"></a>Ограничения ресурсов Teams

Каждый ресурс Teams имеет различные квоты подписки.

- Для подписок на **callRecords**:
  - На организацию: всего 100 подписок

- Для подписок на **chatMessages** (каналы или чаты):
  - На сочетание приложения и канала или чата: 1 подписка
  - На организацию: всего 10 000 подписок

## <a name="subscription-lifetime"></a>Время существования подписки

Время существования подписок ограничено. Приложениям необходимо обновлять подписки до истечения срока их действия. В противном случае им потребуется создавать новые подписки. Список значений, представляющих собой максимально допустимый срок действия, см. в разделе [Максимальный период подписки для каждого из типов ресурсов](/graph/api/resources/subscription#maximum-length-of-subscription-per-resource-type).

Кроме того, приложение в любое время может отменить подписку, чтобы больше не получать уведомления об изменениях.

## <a name="managing-subscriptions"></a>Управление подписками

Клиенты могут создавать, продлевать и удалять подписки.

### <a name="creating-a-subscription"></a>Создание подписки

Чтобы начать получать уведомления об изменениях ресурса, сначала необходимо создать подписку. Это выполняется следующим образом.

1. Клиент отправляет запрос (POST) на подписку для определенного ресурса.

1. Microsoft Graph проверяет запрос.

    - Если запрос является допустимым, Microsoft Graph отправляет маркер проверки на URL-адрес уведомлений.
    - В противном случае Microsoft Graph возвращает сообщение об ошибке с кодом и подробными сведениями.

1. Клиент отправляет маркер проверки в Microsoft Graph.

1. Клиент получает ответ от Microsoft Graph.

Клиент должен хранить идентификатор подписки, чтобы можно было сопоставлять уведомления об изменениях с подписками.

#### <a name="subscription-request-example"></a>Пример запроса на подписку

```http
POST https://graph.microsoft.com/v1.0/subscriptions
Content-Type: application/json
{
  "changeType": "created,updated",
  "notificationUrl": "https://webhook.azurewebsites.net/notificationClient",
  "resource": "/me/mailfolders('inbox')/messages",
  "expirationDateTime": "2016-03-20T11:00:00.0000000Z",
  "clientState": "SecretClientState"
}
```

Необходимы свойства `changeType`, `notificationUrl`, `resource` и `expirationDateTime`. Определения и значения свойств представлены в [описании типа ресурса подписки](/graph/api/resources/subscription).

Свойство `resource` указывает ресурс, для которого будут отслеживаться изменения. Например, вы можете создать подписку на определенную почтовую папку: `me/mailFolders('inbox')/messages` или сделать это от имени пользователя с согласия администратора: `users/john.doe@onmicrosoft.com/mailFolders('inbox')/messages`.

Хотя свойство `clientState` необязательное, рекомендуем указать его в нашем процессе обработки уведомлений об изменениях. Задание этого свойства позволит подтверждать, что полученные уведомления об изменениях поступают от службы Microsoft Graph. По этой причине значение свойства должно оставаться секретным и быть известно только приложению и службе Microsoft Graph.

В случае успешного выполнения Microsoft Graph возвращает код `201 Created` и объект [подписки](/graph/api/resources/subscription) в теле отклика.

> **Примечание.** Любой параметр строки запроса, включенный в свойство **notificationUrl**, будет включен в HTTP-запрос POST при доставке уведомлений.

#### <a name="notification-endpoint-validation"></a>Проверка конечной точки уведомлений

Прежде чем создавать подписку, Microsoft Graph проверяет конечную точку уведомлений в `notificationUrl` запросе на свойство подписки. Проверка происходит следующим образом:

1. Microsoft Graph кодирует маркер проверки и включает его в запрос POST URL-адреса уведомления:

    ``` http
    Content-Type: text/plain; charset=utf-8
    POST https://{notificationUrl}?validationToken={opaqueTokenCreatedByMicrosoftGraph}
    ```

1. Клиенту необходимо правильно расшифровать URL-адрес параметра запроса`validationToken`, предоставленный на предыдущем этапе, и избегать любого HTML или JavaScript.

   Рекомендуется их избегать, поскольку злоумышленники могут использовать конечную точку уведомления для атаки типа межсайтовых сценариев.

   Как правило, значение маркера проверки рассматривается как непрозрачное, так как формат маркера обычно меняется без уведомлений. Microsoft Graph никогда не отправляет значения, содержащие код HTML или JavaScript.

1. В течение 10 секунд первого этапа клиент должен предоставить ответ со следующими характеристиками:

    - Код состояния `HTTP 200 OK`.
    - Тип контента `text/plain`.
    - Основной текст, включающий маркер проверки с _расшифрованным URL-адресом_. Просто отобразите ту же строку, которая была отправлена в параметре запроса `validationToken`.

    Клиент должен удалить маркер проверки после того, как укажет его в отклике.

    > **Важно!** Если клиент возвращает зашифрованный маркер проверки, проверка завершится ошибкой.

Кроме того, можно использовать [коллекцию Microsoft Graph Postman](use-postman.md), чтобы убедиться в правильности реализации запроса проверки в вашей конечной точке. Запрос **Проверка подписки** в папке **Прочее** предоставляет модульные тесты, проверяющие отклик вашей конечной точки.  

![результаты теста отклика проверки](images/change-notifications/validation-request-tests-results.png)

### <a name="renewing-a-subscription"></a>Возобновление подписки

Клиент может продлить подписку, указав срок действия до трех дней с момента отправки запроса. Свойство `expirationDateTime` является обязательным.

#### <a name="subscription-renewal-example"></a>Пример возобновления подписки

```http
PATCH https://graph.microsoft.com/v1.0/subscriptions/{id}
Content-Type: application/json

{
  "expirationDateTime": "2016-03-22T11:00:00.0000000Z"
}
```

В случае успешного выполнения Microsoft Graph возвращает код `200 OK` и объект [подписки](/graph/api/resources/subscription) в теле отклика. Объект подписки включает новое значение `expirationDateTime`.

### <a name="deleting-a-subscription"></a>Удаление подписки

Клиент может прекратить получать уведомления об изменениях, удалив подписку по ее идентификатору.

```http
DELETE https://graph.microsoft.com/v1.0/subscriptions/{id}
```

В случае успешного выполнения Microsoft Graph возвращает код `204 No Content`.

## <a name="change-notifications"></a>Уведомления об изменениях

Когда клиент подписывается на изменения ресурса, Microsoft Graph отправляет запрос `POST` в URL-адрес уведомления при каждом изменении ресурса. Уведомления отправляются только при изменениях типа, указанного в подписке, например, `created`.

> **Примечание.** Если клиент имеет несколько подписок, которые контролируют один ресурс и используют один URL-адрес уведомлений, Microsoft Graph может отправлять несколько уведомлений об изменениях, соответствующих разным подпискам, каждое из которых показывает идентификатор подписки. Уведомления об изменениях из сообщения `POST` могут принадлежать разным подпискам.

### <a name="change-notification-example"></a>Пример уведомления об изменениях

В этом разделе указан пример уведомления для создания сообщения. Когда пользователь получает электронное письмо, Microsoft Graph отправляет уведомления об изменениях, как показано в примере ниже.
Обратите внимание на то, что уведомление является коллекцией, представленной в поле "`value`". Дополнительные сведения о полезных данных уведомлений см. в [changeNotificationCollection](/graph/api/resources/changenotificationcollection) 

При многочисленных изменениях Microsoft Graph может отправлять несколько уведомлений, соответствующих разным подпискам, в одном и том же запросе `POST`.

```json
{
  "value": [
    {
      "id": "lsgTZMr9KwAAA",
      "subscriptionId":"{subscription_guid}",
      "subscriptionExpirationDateTime":"2016-03-19T22:11:09.952Z",
      "clientState":"secretClientValue",
      "changeType":"created",
      "resource":"users/{user_guid}@{tenant_guid}/messages/{long_id_string}",
      "tenantId": "84bd8158-6d4d-4958-8b9f-9d6445542f95",
      "resourceData":
      {
        "@odata.type":"#Microsoft.Graph.Message",
        "@odata.id":"Users/{user_guid}@{tenant_guid}/Messages/{long_id_string}",
        "@odata.etag":"W/\"CQAAABYAAADkrWGo7bouTKlsgTZMr9KwAAAUWRHf\"",
        "id":"{long_id_string}"
      }
    }
  ]
}
```

### <a name="processing-the-change-notification"></a>Обработка уведомлений об изменениях

Процесс должен обрабатывать каждое уведомление об изменениях. Ниже перечислены основные задачи, которые приложение должно выполнить для обработки таких уведомлений.

1. Отправьте код состояния `202 - Accepted` в ответе, предназначенном Microsoft Graph. Если 2хх код не будет получен, Microsoft Graph попытается опубликовать уведомление об изменении несколько раз в течение 4 часов. После этого это уведомление будет удалено.

    > **Примечание.** Отправьте код состояния `202 - Accepted` сразу после получения уведомления об изменениях, еще перед проверкой подлинности. Просто подтвердите получение уведомления об изменениях, чтобы избежать ненужных повторных попыток. Текущее значение времени ожидания — 30 секунд, но это время может быть сокращено в будущем для оптимизации производительности службы. Если URL-адрес уведомления не отвечает в течение 30 секунд на более чем 10% запросов от Microsoft Graph за 10 минут, все уведомления ниже будут отложены и повторено выполнены в течение 4 часов. Если URL-адрес уведомления не отвечает в течение 30 секунд на более чем 20% запросов от Microsoft Graph за 10 минут, все уведомления ниже будут удалены.

1. Проверьте свойство `clientState`. Оно должно соответствовать значению, отправленному с запросом на создание подписки.

    > **Примечание.** Если это не так, уведомление об изменениях не следует рассматривать как действительное. Возможно оно создано не Microsoft Graph и отправлено незаконным субъектом. Вы также можете определить, откуда поступило уведомление об изменениях, и выполнить соответствующие действия.

1. Обновляйте приложение в соответствии с бизнес-логикой.

Повторяйте эти действия для других уведомлений об изменениях в запросе.

## <a name="code-samples"></a>Примеры кода

Указанные ниже примеры кода доступны на сайте GitHub.

- [Обучающий модуль по Microsoft Graph: использование уведомлений об изменениях и отслеживание изменений с помощью Microsoft Graph](https://github.com/microsoftgraph/msgraph-training-changenotifications)
- [Пример веб-перехватчиков Microsoft Graph для Node.js](https://github.com/microsoftgraph/nodejs-webhooks-rest-sample)
- [Пример веб-перехватчиков Microsoft Graph для ASP.NET Core](https://github.com/microsoftgraph/aspnetcore-webhooks-sample)
- [Пример веб-перехватчиков Microsoft Graph для Java Spring](https://github.com/microsoftgraph/java-spring-webhooks-sample)

## <a name="firewall-configuration"></a>Конфигурация брандмауэра

При необходимости можно настроить брандмауэр, который защищает URL-адрес уведомления, чтобы разрешить входящие подключения только из Microsoft Graph. Это позволит снизить дополнительное воздействие недопустимых уведомлений об изменениях, которые отправляются на URL-адрес уведомления. Такие недействительные уведомления об изменениях могут пытаться активировать реализуемую вами пользовательскую логику. Полный список IP-адресов, которые используются Microsoft Graph для доставки уведомлений об изменениях, см в сведениях о[дополнительных конечных точках для Microsoft 365](/office365/enterprise/additional-office365-ip-addresses-and-urls).

> **Примечание.** Указанные IP-адреса, которые используются для доставки уведомлений об изменениях, можно обновлять в любой момент без предварительных примечаний.

## <a name="latency"></a>Задержка

В следующей таблице указаны ожидаемые задержки между возникновением события в службе и доставкой уведомления об изменении.

| Ресурс | Средняя задержка | Максимальная задержка |
|:-----|:-----|:-----|
|[alert][] | Менее 3 минут | 5 минут |
|[callRecord][] | Менее 15 минут | 60 минут |
|[channel][] | Менее 10 секунд | 60 минут |
|[chat][] | Менее 10 секунд | 60 минут |
|[chatMessage][] | Менее 10 секунд | 1 минута |
|[contact][] | Неизвестно | Неизвестно |
|[conversation][] | Неизвестно | Неизвестно |
|[conversationMember][] | Менее 10 секунд | 60 минут |
|[driveItem][] | Менее 1 минуты | 5 минут |
|[event][] | Неизвестно | Неизвестно |
|[group][] | Менее 2 минут | 15 минут |
|[list][] | Менее 1 минуты | 5 минут |
|[message][] | Неизвестно | Неизвестно |
|[presence][] (предварительная версия) | Менее 10 секунд | 1 минута |
|[printer][] | Менее 1 минуты | 5 минут |
|[printTaskDefinition][] | Менее 1 минуты | 5 минут |
|[team][] | Менее 10 секунд | 60 минут |
|[todoTask][] | Менее 2 минут | 15 минут |
|[user][] | Менее 2 минут | 15 минут |

>**Примечание.** Задержка, предусматриваемая для ресурса **alert**, применяется только после создания самого оповещения. Она не включает в себя время, необходимое правилу для создания оповещения на основе данных.

## <a name="see-also"></a>См. также

- [Тип ресурса subscription](/graph/api/resources/subscription?view=graph-rest-1.0&preserve-view=true)
- [Получение подписки](/graph/api/subscription-get?view=graph-rest-1.0&preserve-view=true)
- [Создание подписки](/graph/api/subscription-post-subscriptions?view=graph-rest-1.0&preserve-view=true)
- Тип ресурса [changeNotification](/graph/api/resources/changenotification?view=graph-rest-beta&preserve-view=true)
- Тип ресурса [changeNotificationCollection](/graph/api/resources/changenotificationcollection?view=graph-rest-beta&preserve-view=true)
- [Руководство по уведомлениям об изменениях и отслеживанию изменений](/learn/modules/msgraph-changenotifications-trackchanges)
- [Уведомления жизненного цикла](./webhooks-lifecycle.md)

[contact]: /graph/api/resources/contact
[conversation]: /graph/api/resources/conversation
[driveItem]: /graph/api/resources/driveitem
[event]: /graph/api/resources/event
[group]: /graph/api/resources/group
[message]: /graph/api/resources/message
[user]: /graph/api/resources/user
[alert]: /graph/api/resources/alert
[callRecord]: /graph/api/resources/callrecords-callrecord
[presence]: /graph/api/resources/presence
[chatMessage]: /graph/api/resources/chatmessage
[list]: /graph/api/resources/list
[printer]: /graph/api/resources/printer
[printTaskDefinition]: /graph/api/resources/printtaskdefinition
[todoTask]: /graph/api/resources/todotask
[channel]: /graph/api/resources/channel
[chat]: /graph/api/resources/chat
[conversationMember]: /graph/api/resources/conversationmember
[team]: /graph/api/resources/team
