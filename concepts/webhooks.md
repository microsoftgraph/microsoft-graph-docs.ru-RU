---
title: Настройка уведомлений об изменениях в данных ресурса
description: API Microsoft Graph используют механизм веб-перехватчиков для доставки уведомлений об изменениях клиентам. С помощью уведомлений об изменениях клиентские приложения обновляют свое состояние при изменении.
author: Jumaodhiss
ms.prod: non-product-specific
ms.localizationpriority: high
ms.custom: graphiamtop20
ms.openlocfilehash: aecde366793f0c7132592677e5d1b7f98414ff61
ms.sourcegitcommit: e48fe05125fe1e857225d20ab278352ff7f0911a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/30/2022
ms.locfileid: "66554997"
---
# <a name="set-up-notifications-for-changes-in-resource-data"></a>Настройка уведомлений об изменениях в данных ресурса

API Microsoft Graph использует механизм веб-перехватчиков для доставки уведомлений об изменениях для клиентов. Клиент — это веб-служба, которая настраивает свой URL-адрес для получения уведомлений об изменениях. С помощью этих уведомлений клиентские приложения обновляют свое состояние в случае изменений.

Приняв запрос на подписку, Microsoft Graph отправляет уведомления об изменениях на URL-адрес, указанный в подписке. Затем приложение действует в соответствии с бизнес-логикой. Например, оно получает дополнительные данные, обновляет кэш и представления, а также выполняет другие действия.


> [!VIDEO https://www.youtube-nocookie.com/embed/rC1bunenaq4]
 
> [!div class="nextstepaction"]
> [Руководство: Использование уведомлений об изменениях и функции отслеживания изменений в Microsoft Graph](/learn/modules/msgraph-changenotifications-trackchanges)

По умолчанию уведомления об изменениях не включают данные ресурсов, кроме `id`. Если приложению требуются данные ресурса, оно может вызвать API Microsoft Graph, чтобы получить ресурс полностью. В этой статье описывается работа с уведомлениями об изменениях на примере ресурса **user**.

Приложение также может подписаться на уведомления об изменениях, включающие данные ресурсов, чтобы избежать необходимости дополнительного вызова API для доступа к данным. В этом случае приложению необходимо реализовать дополнительный код для обработки требований таких уведомлений, в частности, ответа на уведомления о жизненном цикле подписки, проверки подлинности уведомлений и расшифровки данных ресурсов. Дополнительные сведения о работе с такими уведомлениями см. в статье [Настройка уведомлений об изменениях, включающих данные ресурсов](webhooks-with-resource-data.md).

## <a name="supported-resources"></a>Поддерживаемые ресурсы

С помощью API Microsoft Graph приложение может подписаться на изменения для следующих ресурсов:

- Облачная печать [printer][]
- Облачная печать [printTaskDefinition][]
- Контент внутри иерархии _любой папки_ [driveItem][] на персональном хранилище OneDrive пользователя
- Контент внутри иерархии _корневой папки_ [driveItem][] на персональном хранилище OneDrive для бизнеса
- [group][]
- Групповой [чат][] Microsoft 365 
- [Событие][] Outlook
- [Сообщение][] Outlook
- Личный [контакт][] Outlook
- [Оповещение][] безопасности
- [Список][] SharePoint
- [callRecord][] в Teams
- [Канал][] Teams 
- [Чат][] Teams
- [chatMessage][] Teams
- [conversationMember][] в Teams
- [presence][] в Teams
- [onlineMeeting][] в Teams
- [Команда][] Teams
- [Задача в приложении "Список дел"][]
- [пользователь][]

### <a name="sample-scenarios"></a>Примеры сценариев

Вы можете создать подписку для следующих сценариев:


|Сценарий  |Query  |
|---------|---------|
|На определенную папку Outlook, например, "Входящие"     |   `me/mailFolders('inbox')/messages`      |
|На ресурс верхнего уровня     | `/me/messages` <br/> `/me/contacts` <br/> `/me/events` <br/> `/users` <br/> `/groups` <br/> `/communications/callRecords`        |
|На определенный экземпляр ресурса     |  `/users/{id}` <br/> `/groups/{id}` <br/> `/groups/{id}/conversations` <br/> `/sites/{site-id}/lists/{list-id}` <br/> `/communications/presences/{id}` <br/> `/communications/onlinemeeting/{meeting-id}`       |
|На любую папку в личном хранилище пользователя в OneDrive     |  `/drives/{id}/root` <br/> `/drives/{id}/root/subfolder`      |
|На корневую папку диска SharePoint/OneDrive для бизнеса     |   `/drive/root`      |
| Либо на новое оповещение [API безопасности](security-concept-overview.md) |`/security/alerts?$filter=status eq 'newAlert'` <br/> `/security/alerts?$filter=vendorInformation/provider eq 'ASC'`|
|На задачи в списке дел пользователя|`/me/todo/lists/{todoTaskListId}/tasks`|

### <a name="azure-ad-resource-limitations"></a>Ограничения ресурсов Azure AD

К ресурсам Azure AD (пользователи, группы) применяются определенные ограничения. В случае их превышения возникают ошибки.

> [!NOTE]
> Эти ограничения не применяются к ресурсам служб, отличных от Azure AD. Например, приложение может создать больше дополнительных подписок на ресурсы `message` или `event`, поддерживаемые службой Exchange Online в составе Microsoft Graph.

- Квоты максимальной подписки:

  - На приложение (для сочетания всех клиентов): 50 000 подписок всего
  - На клиента (для сочетания всех приложений): 1000 подписок всего во всех приложениях
  - На сочетание приложения и клиента: 100 подписок всего

Если какое-либо ограничение превышено, попытки создать подписку приведут к [ответу с ошибкой](errors.md) - `403 Forbidden`. Свойство `message` указывает, какое ограничение превышено.

- Клиенты Azure AD B2C не поддерживаются.

- Уведомления об изменениях для сущностей пользователей не поддерживаются для личных учетных записей Майкрософт.

- В подписках пользователей и групп существует [известная проблема](known-issues.md#change-notifications).

### <a name="outlook-resource-limitations"></a>Ограничения ресурсов Outlook

Доступно не более 1000 активных подписок на почтовый ящик для всех приложений.

### <a name="teams-resource-limitations"></a>Ограничения ресурсов Teams

Каждый ресурс Teams имеет различные квоты подписки.

- Для подписок на **callRecords**:
  - На организацию: всего 100 подписок

- Для подписок на **chatMessages** (каналы или чаты):
  - На сочетание приложения и канала или чата: 1 подписка
  - На организацию: всего 10 000 подписок

- Для подписок на **каналы**:
  - На сочетание приложения и команды: 1 подписка
  - На организацию: всего 10 000 подписок

- Для подписок на **чаты**:
  - На сочетание приложения и чата: 1 подписка
  - На организацию: всего 10 000 подписок

- Для подписок на **команды**:
  - На сочетание приложения и команды: 1 подписка
  - На организацию: всего 10 000 подписок
  
- Для подписок на **conversationMembers**:
  - На сочетание приложения и команды: 1 подписка
  - На организацию: всего 10 000 подписок

## <a name="subscription-lifetime"></a>Время существования подписки

Время существования подписок ограничено. Приложениям необходимо обновлять подписки до истечения срока их действия. В противном случае им потребуется создавать новые подписки. Список значений, представляющих собой максимально допустимый срок действия, см. в разделе [Максимальный период подписки для каждого из типов ресурсов](/graph/api/resources/subscription#maximum-length-of-subscription-per-resource-type).

Кроме того, приложение в любое время может отменить подписку, чтобы больше не получать уведомления об изменениях.

## <a name="managing-subscriptions"></a>Управление подписками

Клиенты могут создавать, продлевать и удалять подписки.

### <a name="creating-a-subscription"></a>Создание подписки

Чтобы начать получать уведомления об изменениях ресурса, сначала необходимо создать подписку. Это выполняется следующим образом.

1. Клиент отправляет запрос (POST) на подписку для определенного ресурса.

1. Microsoft Graph проверяет запрос.

    - Если запрос является допустимым, Microsoft Graph отправляет маркер проверки на URL-адрес уведомлений.
    - В противном случае Microsoft Graph возвращает сообщение об ошибке с кодом и подробными сведениями.

1. Клиент отправляет маркер проверки в Microsoft Graph.

1. Клиент получает ответ от Microsoft Graph.

Клиент должен хранить идентификатор подписки, чтобы можно было сопоставлять уведомления об изменениях с подписками.

#### <a name="subscription-request-example"></a>Пример запроса на подписку

```http
POST https://graph.microsoft.com/v1.0/subscriptions
Content-Type: application/json
{
  "changeType": "created,updated",
  "notificationUrl": "https://webhook.azurewebsites.net/notificationClient",
  "resource": "/me/mailfolders('inbox')/messages",
  "expirationDateTime": "2016-03-20T11:00:00.0000000Z",
  "clientState": "SecretClientState"
}
```

Необходимы свойства `changeType`, `notificationUrl`, `resource` и `expirationDateTime`. Определения и значения свойств представлены в [описании типа ресурса подписки](/graph/api/resources/subscription).

Свойство `resource` указывает ресурс, для которого будут отслеживаться изменения. Например, вы можете создать подписку на определенную почтовую папку: `me/mailFolders('inbox')/messages` или сделать это от имени пользователя с согласия администратора: `users/john.doe@onmicrosoft.com/mailFolders('inbox')/messages`.

Хотя свойство `clientState` необязательное, рекомендуем указать его в нашем процессе обработки уведомлений об изменениях. Задание этого свойства позволит подтверждать, что полученные уведомления об изменениях поступают от службы Microsoft Graph. По этой причине значение свойства должно оставаться секретным и быть известно только приложению и службе Microsoft Graph.

В случае успешного выполнения Microsoft Graph возвращает код `201 Created` и объект [подписки](/graph/api/resources/subscription) в теле отклика.

> [!NOTE]
> Любой параметр строки запроса, включенный в свойство **notificationUrl**, будет включен в HTTP-запрос POST при доставке уведомлений.

#### <a name="notification-endpoint-validation"></a>Проверка конечной точки уведомлений

Прежде чем создавать подписку, Microsoft Graph проверяет конечную точку уведомлений, указанную в свойстве `notificationUrl` запроса подписки. Проверка происходит следующим образом.

1. Microsoft Graph кодирует маркер проверки и включает его в запрос POST URL-адреса уведомления:

    ``` http
    Content-Type: text/plain; charset=utf-8
    POST https://{notificationUrl}?validationToken={opaqueTokenCreatedByMicrosoftGraph}
    ```

1. Клиенту необходимо правильно расшифровать URL-адрес параметра запроса`validationToken`, предоставленный на предыдущем этапе, и избегать любого HTML или JavaScript.

   Рекомендуется их избегать, поскольку злоумышленники могут использовать конечную точку уведомления для атаки типа межсайтовых сценариев.

   Как правило, значение маркера проверки рассматривается как непрозрачное, так как формат маркера обычно меняется без уведомлений. Microsoft Graph никогда не отправляет значения, содержащие код HTML или JavaScript.

1. В течение 10 секунд первого этапа клиент должен предоставить ответ со следующими характеристиками:

    - Код состояния `HTTP 200 OK`.
    - Тип контента `text/plain`.
    - Основной текст, включающий маркер проверки с _расшифрованным URL-адресом_. Просто отобразите ту же строку, которая была отправлена в параметре запроса `validationToken`.

    Клиент должен удалить маркер проверки после того, как укажет его в отклике.

    > [!IMPORTANT]
    > Если клиент возвращает зашифрованный маркер проверки, проверка завершается ошибкой.

Кроме того, можно использовать [коллекцию Microsoft Graph Postman](use-postman.md), чтобы убедиться в правильности реализации запроса проверки в вашей конечной точке. Запрос **Проверка подписки** в папке **Прочее** предоставляет модульные тесты, проверяющие отклик вашей конечной точки.  

![результаты теста отклика проверки](images/change-notifications/validation-request-tests-results.png)

### <a name="renewing-a-subscription"></a>Возобновление подписки

Клиент может возобновить подписку, указав срок действия до трех дней с момента отправки запроса. Свойство `expirationDateTime` является обязательным.

#### <a name="subscription-renewal-example"></a>Пример возобновления подписки

```http
PATCH https://graph.microsoft.com/v1.0/subscriptions/{id}
Content-Type: application/json

{
  "expirationDateTime": "2016-03-22T11:00:00.0000000Z"
}
```

В случае успешного выполнения Microsoft Graph возвращает код `200 OK` и объект [subscription](/graph/api/resources/subscription) в тексте отклика. Объект подписки включает новое значение `expirationDateTime`.

### <a name="deleting-a-subscription"></a>Удаление подписки

Клиент может прекратить получать уведомления об изменениях, удалив подписку по ее идентификатору.

```http
DELETE https://graph.microsoft.com/v1.0/subscriptions/{id}
```

В случае успешного выполнения Microsoft Graph возвращает код `204 No Content`.

## <a name="change-notifications"></a>Уведомления об изменениях

Когда клиент подписывается на изменения ресурса, Microsoft Graph отправляет запрос `POST` в URL-адрес уведомления при каждом изменении ресурса. Уведомления отправляются только при изменениях типа, указанного в подписке, например, `created`.

> [!NOTE]
> Если клиент имеет несколько подписок, которые контролируют один ресурс и используют один URL-адрес уведомлений, Microsoft Graph может отправлять несколько уведомлений об изменениях, соответствующих разным подпискам, каждое из которых содержит идентификатор подписки. Уведомления об изменениях из сообщения `POST` могут принадлежать разным подпискам.

### <a name="change-notification-example"></a>Пример уведомления об изменениях

В этом разделе указан пример уведомления для создания сообщения. Когда пользователь получает электронное письмо, Microsoft Graph отправляет уведомления об изменениях, как показано в примере ниже.
Обратите внимание на то, что уведомление является коллекцией, представленной в поле "`value`". Дополнительные сведения о полезных данных уведомлений см. в [changeNotificationCollection](/graph/api/resources/changenotificationcollection) 

При многочисленных изменениях Microsoft Graph может отправлять несколько уведомлений, соответствующих разным подпискам, в одном и том же запросе `POST`.

```json
{
  "value": [
    {
      "id": "lsgTZMr9KwAAA",
      "subscriptionId":"{subscription_guid}",
      "subscriptionExpirationDateTime":"2016-03-19T22:11:09.952Z",
      "clientState":"secretClientValue",
      "changeType":"created",
      "resource":"users/{user_guid}@{tenant_guid}/messages/{long_id_string}",
      "tenantId": "84bd8158-6d4d-4958-8b9f-9d6445542f95",
      "resourceData":
      {
        "@odata.type":"#Microsoft.Graph.Message",
        "@odata.id":"Users/{user_guid}@{tenant_guid}/Messages/{long_id_string}",
        "@odata.etag":"W/\"CQAAABYAAADkrWGo7bouTKlsgTZMr9KwAAAUWRHf\"",
        "id":"{long_id_string}"
      }
    }
  ]
}
```

### <a name="processing-the-change-notification"></a>Обработка уведомлений об изменениях

Процесс должен обрабатывать каждое уведомление об изменениях. Ниже перечислены основные задачи, которые приложение должно выполнить для обработки таких уведомлений.

1. Процесс должен обрабатывать каждое уведомление об изменениях и отправлять код класса 2xx. Если код класса 2хх не будет получен в течение 3 секунд, Microsoft Graph попытается опубликовать уведомление об изменении несколько раз в течение 4 часов. После этого это уведомление будет удалено. Если процесс последовательно не отвечает в течение 3 секунд, ваше уведомление может подвергаться регулированию.

    Если ожидаемое время обработки превышает 3 секунды, следует сохранить уведомление, вернуть код состояния `202 - Accepted` в отклике для Microsoft Graph, а затем обработать уведомления. Если уведомление не сохранено, верните код класса 5xx для указания на ошибку, чтобы уведомление было удалено.

    Если ожидаемое время обработки составляет менее 3 секунд, следует обработать уведомления и вернуть код состояния `200 - OK` в отклике для Microsoft Graph. Если уведомление не обрабатывается должным образом, верните код класса 5xx для указания на ошибку, чтобы уведомление было удалено.

1. Проверьте свойство `clientState`. Оно должно соответствовать значению, отправленному с запросом на создание подписки.

    > [!NOTE]
    > Если это не так, уведомление об изменении не следует рассматривать как действительное. Возможно оно создано не Microsoft Graph и отправлено незаконным субъектом. Вы также можете определить, откуда поступило уведомление об изменениях, и выполнить соответствующие действия.

1. Обновляйте приложение в соответствии с бизнес-логикой.

Повторяйте эти действия для других уведомлений об изменениях в запросе.

### <a name="throttling"></a>Регулирование

Отправьте код состояния `202 - Accepted` сразу после получения уведомления об изменениях, еще перед проверкой подлинности. Просто подтвердите получение уведомления об изменениях, чтобы избежать ненужных повторных попыток. Для большинства подписок уведомления не подвергаются дополнительной задержке во время публикации, и все уведомления доставляются в рамках SLA, если в службе отсутствуют какие-либо инциденты. Но если URL-адрес уведомлений подписки работает медленно или не реагирует, уведомления могут регулироваться для узла, связанного с подпиской. Следующий процесс используется для определения того, когда применять регулирование и как обрабатывать регулируемые конечные точки.

Уведомления публикуются с помощью HTTP-клиента с 3-секундным временем ожидания. По завершении публикации уведомления (независимо от результатов) общее время, затраченное на публикацию, включая задержку в сети, отслеживается для узла, связанного с URL-адресом уведомлений. Если время публикации превышает 2900 мс, отклик считается медленным. Отклики накапливаются для узла, а процент медленных откликов вычисляется после получения 100 уведомлений. Когда количество медленных откликов достигает 10 %, узел, связанный с URL-адресом уведомлений, помечается как медленная конечная точка. Так как медленные конечные точки связаны с узлом в URL-адресе уведомления, все уведомления для всех подписок, связанных с узлом, предусматриваются для оценки и подвергаются регулированию.

Оценка продолжается в режиме реального времени. Если время публикации для узла опускается ниже 2900 мс, этот быстрый отклик включается в общее количество откликов, процент медленных откликов пересчитывается, а конечная точка оценивается повторно. Кроме того, накопление откликов сбрасывается каждые 10 минут и оценка начинается снова, ожидая 100 уведомлений перед оценкой конечной точки. Таким образом, временный всплеск задержки в сети или задержки публикации восстанавливается после устранения задержки. Более постоянные задержки в сети или задержки публикации длительностью более 2900 мс будут постоянно переоцениваться каждые 10 минут. 

При регулировании конечной точки уведомления подвергаются следующим дополнительным задержкам.
-   Уведомления автоматически разгружаются в набор рабочих ролей, связанных с неудачными или регулируемыми уведомлениями, и накладывается дополнительная задержка в 10 минут.
-   Уведомления удаляются, если для регулируемой конечной точки количество медленных откликов составляет 15 % или более.
-   Уведомления, которые не удалось доставить из-за неудачного вызова HTTP, повторяются через 10 минут.


## <a name="code-samples"></a>Примеры кода

Указанные ниже примеры кода доступны на сайте GitHub.

- [Обучающий модуль по Microsoft Graph: использование уведомлений об изменениях и отслеживание изменений с помощью Microsoft Graph](https://github.com/microsoftgraph/msgraph-training-changenotifications)
- [Пример веб-перехватчиков Microsoft Graph для Node.js](https://github.com/microsoftgraph/nodejs-webhooks-rest-sample)
- [Пример веб-перехватчиков Microsoft Graph для ASP.NET Core](https://github.com/microsoftgraph/aspnetcore-webhooks-sample)
- [Пример веб-перехватчиков Microsoft Graph для Java Spring](https://github.com/microsoftgraph/java-spring-webhooks-sample)

## <a name="firewall-configuration"></a>Конфигурация брандмауэра

При необходимости можно настроить брандмауэр, который защищает URL-адрес уведомления, чтобы разрешить входящие подключения только из Microsoft Graph. Это позволит снизить дополнительное воздействие недопустимых уведомлений об изменениях, которые отправляются на URL-адрес уведомления. Такие недействительные уведомления об изменениях могут пытаться активировать реализуемую вами пользовательскую логику. Полный список IP-адресов, которые используются Microsoft Graph для доставки уведомлений об изменениях, см в сведениях о[дополнительных конечных точках для Microsoft 365](/office365/enterprise/additional-office365-ip-addresses-and-urls).

> [!NOTE]
> Указанные IP-адреса, которые используются для доставки уведомлений об изменениях, можно обновлять в любое время без предупреждения.

## <a name="latency"></a>Задержка

В следующей таблице указаны ожидаемые задержки между возникновением события в службе и доставкой уведомления об изменении.

| Ресурс | Средняя задержка | Максимальная задержка |
|:-----|:-----|:-----|
|[alert][] | Менее 3 минут | 5 минут |
|[callRecord][] | Менее 15 минут | 60 минут |
|[channel][] | Менее 10 секунд | 60 минут |
|[chat][] | Менее 10 секунд | 60 минут |
|[chatMessage][] | Менее 10 секунд | 1 минута |
|[contact][] | Неизвестно | Неизвестно |
|[conversation][] | Неизвестно | Неизвестно |
|[conversationMember][] | Менее 10 секунд | 60 минут |
|[driveItem][] | Менее 1 минуты | 5 минут |
|[event][] | Неизвестно | Неизвестно |
|[group][] | Менее 2 минут | 15 минут |
|[list][] | Менее 1 минуты | 5 минут |
|[message][] | Неизвестно | Неизвестно |
|[onlineMeeting][] | Менее 10 секунд | 1 минута |
|[presence][] | Менее 10 секунд | 1 минута |
|[printer][] | Менее 1 минуты | 5 минут |
|[printTaskDefinition][] | Менее 1 минуты | 5 минут |
|[team][] | Менее 10 секунд | 60 минут |
|[todoTask][] | Менее 2 минут | 15 минут |
|[user][] | Менее 2 минут | 15 минут |

> [!NOTE]
> Задержка, предусматриваемая для ресурса **alert**, применяется только после создания самого оповещения. Она не включает в себя время, необходимое правилу для создания оповещения на основе данных.

## <a name="see-also"></a>См. также

- [Тип ресурса subscription](/graph/api/resources/subscription)
- [Получение подписки](/graph/api/subscription-get)
- [Создание подписки](/graph/api/subscription-post-subscriptions)
- Тип ресурса [changeNotification](/graph/api/resources/changenotification)
- Тип ресурса [changeNotificationCollection](/graph/api/resources/changenotificationcollection)
- [Руководство по уведомлениям об изменениях и отслеживанию изменений](/learn/modules/msgraph-changenotifications-trackchanges)
- [Уведомления жизненного цикла](./webhooks-lifecycle.md)

[contact]: /graph/api/resources/contact
[conversation]: /graph/api/resources/conversation
[driveItem]: /graph/api/resources/driveitem
[event]: /graph/api/resources/event
[group]: /graph/api/resources/group
[message]: /graph/api/resources/message
[user]: /graph/api/resources/user
[alert]: /graph/api/resources/alert
[callRecord]: /graph/api/resources/callrecords-callrecord
[presence]: /graph/api/resources/presence
[chatMessage]: /graph/api/resources/chatmessage
[list]: /graph/api/resources/list
[printer]: /graph/api/resources/printer
[printTaskDefinition]: /graph/api/resources/printtaskdefinition
[Задача в приложении "Список дел"]: /graph/api/resources/todotask
[channel]: /graph/api/resources/channel
[chat]: /graph/api/resources/chat
[conversationMember]: /graph/api/resources/conversationmember
[team]: /graph/api/resources/team
[onlineMeeting]: /graph/api/resources/onlinemeeting