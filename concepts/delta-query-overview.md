---
title: Отслеживание изменений в данных Microsoft Graph с помощью разностного запроса
description: Запросы изменений позволяют приложениям обнаруживать новые, обновленные и удаленные сущности, не считывая целевой ресурс полностью при каждом запросе. Приложения Microsoft Graph могут использовать запросы изменений, чтобы эффективно синхронизировать изменения с локальным хранилищем данных.
author: FaithOmbongi
ms.localizationpriority: high
ms.custom: graphiamtop20
ms.openlocfilehash: 4331c661889868bdbf7735e7ef476739d63621fc
ms.sourcegitcommit: 972d83ea471d1e6167fa72a63ad0951095b60cb0
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2022
ms.locfileid: "65247079"
---
# <a name="use-delta-query-to-track-changes-in-microsoft-graph-data"></a>Отслеживание изменений в данных Microsoft Graph с помощью разностного запроса

Запросы изменений позволяют приложениям обнаруживать новые, обновленные и удаленные сущности, не считывая целевой ресурс полностью при каждом запросе. Приложения Microsoft Graph могут использовать запросы изменений, чтобы эффективно синхронизировать изменения с локальным хранилищем данных.

> [!div class="nextstepaction"]
> [Руководство. Использование уведомлений об изменениях и функции отслеживания изменений в Microsoft Graph](/learn/modules/msgraph-changenotifications-trackchanges)

## <a name="use-delta-query-to-track-changes-in-a-resource-collection"></a>Отслеживание изменений в коллекции ресурсов с помощью запроса изменений

Ниже представлен типичный шаблон вызова.

1. Для начала приложение выполняет запрос GET с функцией delta для нужного ресурса.
2. Microsoft Graph отправит ответ, содержащий нужный ресурс и [маркер состояния](#state-tokens).

     -  Если возвращается URL-адрес `@odata.nextLink`, это означает, что во время сеанса могли быть получены не все страницы данных. Для получения всех страниц данных приложение продолжает отправлять запросы, используя URL-адрес `@odata.nextLink`, пока в отклик не будет включен URL-адрес `@odata.deltaLink`.

     - Если возвращается URL-адрес `@odata.deltaLink`, это означает, что больше нет данных о текущем состоянии ресурса. В последующих запросах приложение использует URL-адрес `@odata.deltaLink`, чтобы узнавать об изменениях ресурса.

3. Когда приложению требуется узнать об изменениях ресурса, оно совершает новый запрос, используя URL-адрес `@odata.deltaLink`, полученный на шаге 2. Этот запрос *может* быть совершен сразу по завершении шага 2 или когда приложение проверяет наличие изменений.
4. Microsoft Graph возвращает описание изменений ресурса с момента последнего запроса вместе с URL-адресом `@odata.nextLink` или `@odata.deltaLink`.

>**Примечание.** Ресурсы, хранящиеся в Azure Active Directory (например, пользователи и группы), поддерживают сценарии "синхронизировать с этого момента". Это позволит пропустить действия 1 и 2 (если вы не хотите получать полное состояние ресурса) и запросить последнюю `@odata.deltaLink`. Добавьте `$deltaToken=latest` к функции `delta`, и ответ будет содержать ссылку `@odata.deltaLink`, но не будет содержать данные ресурсов. Ресурсы в OneDrive и SharePoint также поддерживают эту функцию. Для ресурсов в OneDrive и SharePoint вместо этого добавьте `token=latest`.

>**Примечание:** Функция запроса изменений обычно упоминается путем добавления `/delta` к имени ресурса. Тем не менее, `/delta` - это сокращение для полного имени`/microsoft.graph.delta`, которое вы видите в запросах, генерируемых Microsoft Graph SDK.

>**Примечание.** Исходный запрос к функции разностный запроса (не `$deltaToken` или `$skipToken` ) вернет ресурсы, которые в настоящее время существуют в коллекции. Ресурсы, созданные и удаленные до исходного разностного запроса, не возвращаются. Обновления, внесенные до исходного запроса, обобщаются в возвращаемом ресурсе в их последнем состоянии. 

### <a name="state-tokens"></a>Маркеры состояния

Ответ GET на запрос изменений всегда включает URL-адрес, указанный в заголовке `@odata.nextLink` или `@odata.deltaLink`. URL-адрес `@odata.nextLink` включает маркер `$skipToken`, а URL-адрес `@odata.deltaLink` — `$deltaToken`.

Эти маркеры непрозрачны для клиента. Вот что вам нужно знать о них:

- Каждый маркер отражает состояние и представляет моментальный снимок ресурса в этом цикле отслеживания изменений.

- Маркеры состояния также кодируют и включают другие параметры запроса (такие как `$select`), указанные в исходном запросе изменений. Таким образом, не обязательно повторять их в последующих запросах изменений.

- Совершая запрос изменений, вы можете скопировать и применить URL-адрес `@odata.nextLink` или `@odata.deltaLink` при следующем вызове функции **delta**, не проверяя содержимое URL-адреса, в том числе маркер состояния.

### <a name="optional-query-parameters"></a>Необязательные параметры запросов

Если клиент использует параметр запроса, он должен быть указан в исходном запросе. Microsoft Graph автоматически кодирует указанный параметр в ссылке `@odata.nextLink` или `@odata.deltaLink`, указанной в ответе. Вызывающему приложению достаточно один раз указать параметры запроса. Microsoft Graph автоматически добавляет указанные параметры для всех последующих запросов.

Обратите внимание на общую ограниченную поддержку следующих необязательных параметров запроса:

- `$orderby`

    Не считайте, что разностный запрос возвращает определенную последовательность ответов. Предполагайте, что один и тот же элемент может встречаться в любом месте последовательности `@odata.nextLink`, и учитывайте это в логике объединения.
- `$top`

    Число объектов на каждой странице зависит от типа ресурса и типа изменений, внесенных в ресурс.

См. сведения о [поддержке параметров разностного запроса](delta-query-messages.md#use-query-parameters-in-a-delta-query-for-messages) для ресурса [message](/graph/api/resources/message).

Для ресурсов [user](/graph/api/resources/user) и [group](/graph/api/resources/group) действуют ограничения на применение некоторых параметров запроса:

- Параметр `$expand` не поддерживается.
- Параметр `$top` не поддерживается.
- Параметр `$orderby` не поддерживается.
- Если используется параметр запроса `$select`, это означает, что клиент предпочитает отслеживать изменения только для тех свойств или связей, которые указаны в операторе `$select`. При изменении свойства, которое не было выбрано, соответствующий ресурс не появится в отклике с различиями при последующем запросе.
- `$select` также поддерживает свойства навигации **руководителя** и **участников** для пользователей и групп соответственно. Выбор этих свойств позволяет отслеживать изменения руководства и участия в группах для пользователя.

- Фильтры области позволяют отслеживать изменения одного или нескольких конкретных пользователей или групп с помощью идентификатора объекта. Например, следующий запрос возвращает изменения для групп, соответствующих идентификаторам, указанным в фильтре запроса.

<!-- {
  "blockType": "request",
  "name": "group_delta"
}-->
```http
https://graph.microsoft.com/beta/groups/delta/?$filter=id eq '477e9fc6-5de7-4406-bb2a-7e5c83c9ae5f' or id eq '004d6a07-fe70-4b92-add5-e6e37b8acd8e'
```

## <a name="resource-representation-in-the-delta-query-response"></a>Представление ресурсов в отклике на разностный запрос

- Новые экземпляры поддерживаемого ресурса представлены в ответе на запрос изменений с помощью стандартных свойств.

- Обновленные экземпляры представлены **id** и *по крайней мере* обновленными свойствами, но могут быть включены и другие свойства.

- Отношения пользователей и групп представлены в виде заметок к стандартному представлению ресурсов. Эти заметки используют формат **propertyName@delta**. Заметки включаются в отклик на исходный разностный запрос.

Удаленные экземпляры представлены своим **идентификатором** и объектом **@removed**. Объект **@removed** может включать дополнительные сведения о том, почему экземпляр был удален. Например, `"@removed": {"reason": "changed"}`.

Возможные причины **@removed** могут быть `changed` или `deleted`.

- `changed` указывает, что элемент удален и может быть восстановлен из [deletedItems](/graph/api/resources/directory).

- `deleted` указывает, что элемент удален и не может быть восстановлен.

Объект **@removed** может быть возвращен в исходном ответе на дельта-запрос и в отслеживаемых ответах (deltaLink). Клиенты, использующие разностные запросы, должны быть спроектированы так, чтобы обрабатывать эти объекты в откликах.

>**Примечание:** Возможно, что одна сущность будет содержаться в ответе несколько раз, если эта сущность менялась несколько раз и при определенных условиях. Запрос изменений позволяют вашему приложению перечислять все изменения, но не могут гарантировать, что объекты объединены в одном ответе.

## <a name="supported-resources"></a>Поддерживаемые ресурсы

Разностные запросы поддерживаются для указанных ниже ресурсов. Обратите внимание, что у некоторых ресурсов, доступных в версии 1.0, соответствующие функции **delta** по-прежнему находятся в состоянии предварительной версии, как указано.

| **Коллекция ресурсов**                                        | **API**                                                                                                                                                      |
| :------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Приложения                                                   | Функция [delta](/graph/api/application-delta) ресурса [application](/graph/api/resources/application)                                               |
| Административные единицы (предварительная версия)                                 | Функция [delta](/graph/api/administrativeunit-delta) (предварительная версия) ресурса [administrativeUnit](/graph/api/resources/administrativeunit)                |
| Категории заданий                                          | функция [delta](/graph/api/educationcategory-delta) ресурса [educationCategory](/graph/api/resources/educationcategory)                                    |
| Сообщения чата в канале                                     | Функция [delta](/graph/api/chatmessage-delta) (предварительная версия) ресурса [chatMessage](/graph/api/resources/chatmessage)                                              |
| Перечисление ролей каталога                                                | Функция [delta](/graph/api/directoryrole-delta) ресурса [directoryObjects](/graph/api/resources/directoryrole) |
| Элементы на диске\*                                                  | Функция [delta](/graph/api/driveitem-delta) ресурса [driveItem](/graph/api/resources/driveitem)             |
| Задания образовательных учреждений                                          | функция [delta](/graph/api/educationassignment-delta) ресурса [educationAssignment](/graph/api/resources/educationassignment)                                    |
| Классы образовательных учреждений                                              | Функция [delta](/graph/api/educationclass-delta) ресурса [educationClass](/graph/api/resources/educationclass)                                      |
| Пользователи образовательных учреждений                                                | Функция [delta](/graph/api/educationuser-delta) ресурса [educationUser](/graph/api/resources/educationuser)                                         |
| Образовательная школа                                              | Функция [delta](/graph/api/educationschool-delta) ресурса [educationSchool](/graph/api/resources/educationschool)                                   |
| События в представлении (диапазоне дат) основного календаря | Функция [delta](/graph/api/event-delta) ресурса [event](/graph/api/resources/event)                         |
| Группы                                                         | Функция [delta](/graph/api/group-delta) ресурса [group](/graph/api/resources/group)                         |
| Папки почты                                                   | Функция [delta](/graph/api/mailfolder-delta) ресурса [mailFolder](/graph/api/resources/mailfolder)          |
| Сообщения в папке                                           | Функция [delta](/graph/api/message-delta) ресурса [message](/graph/api/resources/message)                   |
| Контакты организации                                        | функция[delta](/graph/api/orgcontact-delta) ресурса [orgContact](/graph/api/resources/orgcontact)          |
| OAuth2PermissionGrants                                         | Функция [delta](/graph/api/oauth2permissiongrant-delta) ресурса [oauth2permissiongrant](/graph/api/resources/oauth2permissiongrant)                 |
| Папки личных контактов                                       | Функция [delta](/graph/api/contactfolder-delta) ресурса [contactFolder](/graph/api/resources/contactfolder) |
| Личные контакты в папке                                  | Функция [delta](/graph/api/contact-delta) ресурса [contact](/graph/api/resources/contact)                   |
| Элементы Planner\*\* (предварительная версия)                                    | Функция [delta](/graph/api/planneruser-list-delta) (предварительная версия) всего сегмента ресурса [plannerUser](/graph/api/resources/planneruser)                 |
| Субъекты-службы                                             | Функция [delta](/graph/api/serviceprincipal-delta) ресурса [servicePrincipal](/graph/api/resources/serviceprincipal)                                |
| Задачи в списке задач                                           | Функция [delta](/graph/api/todotask-delta) ресурса [todoTask](/graph/api/resources/todotask)                                                        |
| Списки задач                                                     | Функция [delta](/graph/api/todotasklist-delta) ресурса [todoTaskList](/graph/api/resources/todotasklist)                                            |
| Пользователи                                                          | Функция [delta](/graph/api/user-delta) ресурса [user](/graph/api/resources/user)                            |


> \* Небольшие различия в использовании ресурсов OneDrive и других поддерживаемых ресурсов касаются синтаксиса. Разностный запрос для дисков будет обновлен в соответствии с запросами для других типов ресурсов. Дополнительные сведения о текущем синтаксисе см. в статье [Отслеживание изменений на диске](/graph/api/driveitem-delta).

> \*\* Шаблон использования ресурсов Планировщика незначительно отличается от шаблонов использования других поддерживаемых ресурсов. Дополнительные сведения см. в статье [Отслеживание изменений для Планировщика](/graph/api/planneruser-list-delta).

## <a name="limitations"></a>Ограничения

### <a name="properties-stored-outside-of-the-main-data-store"></a>Свойства, хранящиеся вне основного хранилища данных

Некоторые ресурсы содержат свойства, которые хранятся вне основного хранилища данных для ресурса (например, ресурс user в основном хранится в системе Azure AD, в то время как некоторые свойства, такие как **skills**, хранятся в SharePoint Online). В настоящее время эти свойства не поддерживаются как часть отслеживания изменений; изменение одного из этих свойств не приведет к отображению объекта в отклике на разностный запрос. В настоящее время только свойства, хранящиеся в главном хранилище данных, активируют изменения в разностном запросе.

Чтобы проверить, можно ли использовать свойство в разностном запросе, попробуйте выполнить обычную операцию `GET` в коллекции ресурсов и выберите интересующее вас свойство. Например, можно попробовать свойство **skills** в коллекции пользователей.

```msgraph-interactive
GET https://graph.microsoft.com/v1.0/users/?$select=skills
```

Так как свойство **skills** хранится вне Azure AD, отклик будет следующим.

<!-- {
  "blockType": "response",
  "truncated": true,
  "@odata.type": "microsoft.graph.user",
  "isCollection": true
} -->

```http
HTTP/1.1 501 Not Implemented
Content-type: application/json

{
    "error": {
        "code": "NotImplemented",
        "message": "This operation target is not yet supported.",
        "innerError": {
            "request-id": "...",
            "date": "2019-09-20T21:47:50"
        }
    }
}
```

Это говорит о том, что свойство **skills** не поддерживается для разностного запроса в ресурсе **user**.

### <a name="navigation-properties"></a>Свойства навигации

Свойства навигации не поддерживаются. Например, нельзя отслеживать изменения в коллекции пользователей, включающие изменения их свойства **photo**; **photo** — это свойство навигации, которое хранится вне сущности пользователя, внесенные в него изменения не приводят к включению объекта "пользователь" в отклик с различиями.

### <a name="processing-delays"></a>Задержка обработки

Ожидайте различные задержки между моментом, когда изменения вносятся в экземпляр ресурса, который может быть через интерфейс приложения или API, и временем, когда отслеживаемое изменение отражается в ответе запроса изменений.

Иногда изменения, произошедшие с объектом, могут не указываться при выборе `@odata.nextLink` или `@odata.deltaLink`. Дело в том, что в некоторых запросах могут возникнуть задержки репликации для объектов, которые были недавно созданы, обновлены или удалены. Повторите `@odata.nextLink` или `@odata.deltaLink` через некоторое время, чтобы получить последние изменения.

### <a name="national-clouds"></a>Национальные облачные развертывания

Запросы изменений доступны для клиентов, размещенных в общедоступном облаке и Microsoft Graph China, управляемых только 21Vianet.

### <a name="replays"></a>Повторения

Ваше приложение должно быть готово к повторениям, которые происходят, когда одинаковое изменение возникает в последующих откликах. Хотя разностный запрос является оптимальным средством сокращения повторений, они по-прежнему возможны.

### <a name="synchronization-reset"></a>Сброс синхронизации

Разностный запрос может возвращать код отклика `410 (gone)` и заголовок **Расположения**, содержащий пустой URL-адрес запроса `$deltaToken` (такой же, как и исходный запрос). Это означает, что приложение требуется перезапустить с полной синхронизацией целевого клиента. Обычно это происходит, чтобы предотвратить несоответствие данных из-за внутреннего обслуживания или миграции целевого клиента.

### <a name="token-duration"></a>Длительность маркера

Токены изменений действительны только в течение определенного периода, прежде чем клиентскому приложению потребуется снова выполнить полную синхронизацию.
+ Для [объектов каталога](/graph/api/resources/directoryobject) ограничение составляет семь дней. 
+ Для образовательных объектов (**educationSchool**, **educationUser** и **educationClass**) ограничение составляет семь дней.
+ Для объектов Outlook (**message**, **mailFolder**, **event**, **contact**, **contactFolder**, **todoTask** и **todoTaskList**) верхнее ограничение не фиксировано; оно зависит от размера внутреннего кэша разностного маркера. Хотя новые разностные маркеры непрерывно добавляются в кэш, после превышения емкости кэша старые разностные маркеры удаляются.

В случае просроченного маркера служба должна отреагировать ошибкой серии 40X с кодами ошибок, такими как `syncStateNotFound`. Дополнительные сведения см. в разделе (Коды ошибок в Microsoft Graph](/graph/errors#code-property).

## <a name="prerequisites"></a>Предварительные требования

Выполнение разностных запросов для определенного ресурса требует тех же [разрешений](./permissions-reference.md), что и его чтение.

## <a name="delta-query-request-examples"></a>Примеры разностных запросов

- [Получение добавочных изменений для событий в представлении календаря](delta-query-events.md)
- [Получение добавочных изменений сообщений в папке](./delta-query-messages.md)
- [Получение добавочных изменений групп](./delta-query-groups.md)
- [Получение добавочных изменений пользователей](./delta-query-users.md)
