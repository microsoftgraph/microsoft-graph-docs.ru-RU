---
title: Объединение нескольких запросов в один вызов HTTP с помощью пакетной обработки JSON
description: Используйте пакетную обработку JSON для оптимизации вашего приложения путем объединения нескольких запросов в один объект JSON, что позволяет значительно снизить задержку приложения в сети.
author: FaithOmbongi
ms.localizationpriority: high
ms.custom: graphiamtop20
ms.openlocfilehash: 7ba6dace8424158c7d04279de3c53e1734681e00
ms.sourcegitcommit: e48fe05125fe1e857225d20ab278352ff7f0911a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/30/2022
ms.locfileid: "66555781"
---
# <a name="combine-multiple-requests-in-one-http-call-using-json-batching"></a>Объединение нескольких запросов в один вызов HTTP с помощью пакетной обработки JSON

Пакетная обработка JSON позволяет оптимизировать приложение, объединив несколько запросов (до 20) в один объект JSON. Например, клиент может создать представление из таких несвязанных данных:

- Изображение, хранящееся в OneDrive
- Список задач Планировщика
- Календарь группы

Объединение трех этих запросов в один может значительно снизить задержку в сети, ускорив работу приложения.

Microsoft Graph реализует сегмент пути URL-адреса OData `$batch` для поддержки пакетной обработки JSON.

> [!VIDEO https://www.youtube-nocookie.com/embed/tzWGOp8zYh8]

## <a name="first-json-batch-request"></a>Первый пакетный запрос JSON

Сначала нужно создать пакетный запрос JSON для предыдущего примера. В этом сценарии отдельные запросы никак не зависят друг от друга, поэтому их можно поместить в пакетный запрос в любом порядке.

```msgraph-interactive
POST https://graph.microsoft.com/v1.0/$batch
Accept: application/json
Content-Type: application/json

{
  "requests": [
    {
      "id": "1",
      "method": "GET",
      "url": "/me/drive/root:/{file}:/content"
    },
    {
      "id": "2",
      "method": "GET",
      "url": "/me/planner/tasks"
    },
    {
      "id": "3",
      "method": "GET",
      "url": "/groups/{id}/events"
    },
    {
      "id": "4",
      "url": "/me",
      "method": "PATCH",
      "body": {
        "city" : "Redmond"
      },
      "headers": {
        "Content-Type": "application/json"
      }
    },
    {
      "id": "5",
      "url": "users?$select=id,displayName,userPrincipalName&$filter=city eq null&$count=true",
      "method": "GET",
      "headers": {
        "ConsistencyLevel": "eventual"
      }
    }
  ]
}
```

Отклики на пакетные запросы могут отображаться в разном порядке. Для сопоставления отдельных запросов и откликов можно использовать свойство **id**.

```http
200 OK
Content-Type: application/json

{
  "responses": [
    {
      "id": "1",
      "status": 302,
      "headers": {
        "location": "https://b0mpua-by3301.files.1drv.com/y23vmagahszhxzlcvhasdhasghasodfi"
      }
    },
    {
      "id": "3",
      "status": 401,
      "body": {
        "error": {
          "code": "Forbidden",
          "message": "..."
        }
      }
    },
    {
      "id": "5",
      "status": 200,
      "headers": {
        "OData-Version": "4.0",
      },
      "body": {
        "@odata.context": "https://graph.microsoft.com/v1.0/$metadata#users(id,displayName,userPrincipalName)",
        "@odata.count": 12,
        "value": [
          {
            "id": "071cc716-8147-4397-a5ba-b2105951cc0b",
            "displayName": "Adele Vance",
            "userPrincipalName": "AdeleV@Contoso.com"
          }
        ]
      }
    },
    {
      "id": "2",
      "status": 200,
      "body": {
        "@odata.context": "https://graph.microsoft.com/v1.0/$metadata#Collection(microsoft.graph.plannerTask)",
        "value": []
      }
    },
    {
      "id": "4",
      "status": 204,
      "body": null
    }
  ]
}
```

## <a name="request-format"></a>Формат запроса

Пакетные запросы всегда отправляются с помощью метода **POST** в конечную точку `/$batch`.

Текст пакетного запроса JSON состоит из одного объекта JSON с один обязательным свойством: **requests**. Свойство **requests** является коллекцией отдельных запросов. Для каждого отдельного запроса требуются свойства можно передать следующие свойства.


| Свойство | Описание |
|----------|-------------|
| id       | Обязательное. Значение для сопоставления отдельных откликов с запросами. Это значение позволяет серверу обрабатывать запросы в пакете в наиболее эффективном порядке.    |
| метод   | Обязательный аргумент. Метод HTTP.    |
| url      | Обязательный аргумент. Относительный URL-адрес ресурса, на который обычно отправляется отдельный запрос. Таким образом, если абсолютный URL-адрес выглядит так: `https://graph.microsoft.com/v1.0/users`, то этот URL-адрес выглядит так: `/users`. |
| заголовки   | Не является обязательным, но требуется, когда указан элемент **body**. Объект JSON с парой ключей и значений для заголовков. Например, если требуется заголовок **ConsistencyLevel**, это свойство будет представлено как `"headers": {"ConsistencyLevel": "eventual"}`. Если предоставлен элемент **body**, должен быть включен заголовок **Content-Type**.    |
| body   | Необязательно. Может быть объектом JSON или значением в кодировке URL Base64 (например, если элемент body является изображением). Когда элемент **body** включен в запрос, объект **headers** должен содержать значение для свойства **Content-Type**. |

## <a name="response-format"></a>Формат ответа

Формат ответа для пакетных запросов JSON почти такой же, как формат запроса. Ниже приведены основные различия.

* Свойство в основном объекте JSON называется **responses**, а не **requests**.
* Порядок отображения ответов и запросов может отличаться.
* Вместо свойств **method** и **url** отдельные отклики содержат свойство **status**. Значение свойства **status** — число, соответствующее коду состояния HTTP.
* Свойство **заголовков** в каждом отдельном ответе представляет заголовки, возвращаемые сервером, например заголовки **Cache-Control** и **Content-Type**.

Пакетный ответ обычно содержит код состояния `200` или `400`. Если пакетный запрос имеет неправильный формат, код состояния — `400`. Если пакетный запрос пригоден для анализа, код состояния — `200`. Код состояния `200` пакетного ответа не указывает на успешное выполнение отдельных запросов в пакете. Именно поэтому у каждого отдельного отклика в свойстве **responses** есть код состояния.

## <a name="sequencing-requests-with-the-dependson-property"></a>Выстраивание последовательности запросов с помощью свойства dependsOn

С помощью свойства **dependsOn** можно задать порядок выполнения запросов. Это свойство представляет собой массив строк, которые ссылаются на значения **id** различных отдельных запросов. Поэтому значения **id** должны быть уникальными. Например, в следующем запросе клиент указывает, что в первую очередь нужно выполнить запрос 1, затем запрос 3, затем запрос 2 и запрос 4.

```json
{
  "requests": [
    {
      "id": "1",
      "method": "GET",
      "url": "..."
    },
    {
      "id": "2",
      "dependsOn": [ "1" ],
      "method": "GET",
      "url": "..."
    },
    {
      "id": "4",
      "dependsOn": [ "2" ],
      "method": "GET",
      "url": "..."
    },
    {
      "id": "3",
      "dependsOn": [ "4" ],
      "method": "GET",
      "url": "..."
    }
  ]
}
```

Если отдельный запрос не будет выполнен, то любой зависящий от него запрос также не будет выполнен с кодом состояния `424` (ошибка зависимости).

> [!TIP]
> Пакет должен быть полностью последовательным или полностью параллельным.

## <a name="bypassing-url-length-limitations-with-batching"></a>Обход ограничения на длину URL-адреса с помощью пакетной обработки

Еще один вариант использования пакетной обработки JSON — обход ограничения на длину URL-адреса. Если предложение фильтра сложное, длина URL-адреса может превышать ограничения, встроенные в браузеры или другие HTTP-клиенты. Для выполнения таких запросов можно использовать пакетную обработку JSON, так как длинные URL-адреса просто станут частью полезных данных запроса.

## <a name="batch-size-limitations"></a>Ограничения размера пакетов

Пакетные запросы JSON в настоящее время ограничены 20 отдельными запросами в дополнение к следующим ограничениям:

* В зависимости от интерфейсов API, входящих в состав пакетного запроса, базовые службы налагают собственные ограничения регулирования, влияющие на приложения, которые используют Microsoft Graph для доступа к ним.
* Запросы в пакете проверяются по отдельности на предмет ограничений регулирования. Если какой-либо запрос превышает ограничения, для него выдается ошибка с состоянием `429`.
* Пакеты, предназначенные для ресурсов Outlook (например, почта и календарь) могут содержать только четыре запроса, предназначенных для одного и того же почтового ящика. Дополнительные сведения см. статье [Ограничения службы Outlook][throttling-outlook].

Дополнительные сведения см в статье [Регулирование и пакетная обработка][throttling-and-batching].

## <a name="known-issues"></a>Известные проблемы

Список текущих ограничений, связанных с пакетной обработкой, см. в разделе [Известные проблемы][batching-known-issues].

[batching-known-issues]: known-issues.md#json-batching
[odata-4.01-json]: https://www.oasis-open.org/committees/download.php/60365/odata-json-format-v4.01-wd02-2017-03-24.docx
[throttling-and-batching]: throttling.md#throttling-and-batching
[throttling-outlook]: throttling.md#outlook-service-limits

## <a name="see-also"></a>См. также

Дополнительные сведения о формате пакетных запросов и ответов JSON см. в [спецификации формата JSON OData версии 4.01](http://docs.oasis-open.org/odata/odata-json-format/v4.01/odata-json-format-v4.01.html#sec_BatchRequestsandResponses), раздел _Пакетные запросы и ответы_.
