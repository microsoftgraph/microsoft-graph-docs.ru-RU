---
title: Объединение нескольких запросов в один вызов HTTP с помощью пакетной обработки JSON
description: 'Пакетная обработка JSON позволяет оптимизировать приложение, объединив несколько запросов в один объект JSON. Например, клиент может создать представление из таких несвязанных данных:'
author: davidmu1
ms.localizationpriority: high
ms.custom: graphiamtop20
ms.openlocfilehash: cd90a63bfd75a4a6fd66f376bf826780883574f8
ms.sourcegitcommit: 6c04234af08efce558e9bf926062b4686a84f1b2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/12/2021
ms.locfileid: "59052841"
---
# <a name="combine-multiple-requests-in-one-http-call-using-json-batching"></a>Объединение нескольких запросов в один вызов HTTP с помощью пакетной обработки JSON

Пакетная обработка JSON позволяет оптимизировать приложение, объединив несколько запросов (до 20) в один объект JSON. Например, клиент может создать представление из таких несвязанных данных:

1. Изображение, хранящееся в OneDrive
2. Список задач Планировщика
3. Календарь группы

Объединение трех этих запросов в один может значительно снизить задержку в сети, ускорив работу приложения.

> [!VIDEO https://www.youtube-nocookie.com/embed/tzWGOp8zYh8]

## <a name="first-json-batch-request"></a>Первый пакетный запрос JSON

Сначала нужно создать пакетный запрос JSON для предыдущего примера. В этом сценарии отдельные запросы никак не зависят друг от друга, поэтому их можно поместить в пакетный запрос в любом порядке.

```http
POST https://graph.microsoft.com/v1.0/$batch
Accept: application/json
Content-Type: application/json
```

```json
{
  "requests": [
    {
      "id": "1",
      "method": "GET",
      "url": "/me/drive/root:/{file}:/content"
    },
    {
      "id": "2",
      "method": "GET",
      "url": "/me/planner/tasks"
    },
    {
      "id": "3",
      "method": "GET",
      "url": "/groups/{id}/events"
    },
    {
      "id": "4",
      "url": "/me",
      "method": "PATCH",
      "body": {
        "city" : "Redmond"
      },
      "headers": {
        "Content-Type": "application/json"
      }
    }
  ]
}
```

Ответы на пакетные запросы могут отображаться в другом порядке. Для сопоставления отдельных запросов и ответов можно использовать свойство `id`.

```http
200 OK
Content-Type: application/json
```

```json
{
  "responses": [
    {
      "id": "1",
      "status": 302,
      "headers": {
        "location": "https://b0mpua-by3301.files.1drv.com/y23vmagahszhxzlcvhasdhasghasodfi"
      }
    },
    {
      "id": "3",
      "status": 401,
      "body": {
        "error": {
          "code": "Forbidden",
          "message": "..."
        }
      }
    },
    {
      "id": "2",
      "status": 200,
      "body": {
        "@odata.context": "https://graph.microsoft.com/v1.0/$metadata#Collection(microsoft.graph.plannerTask)",
        "value": []
      }
    },
    {
      "id": "4",
      "status": 204,
      "body": null
    }
  ]
}
```

## <a name="request-format"></a>Формат запроса

Пакетные запросы всегда отправляются с помощью метода `POST` в конечную точку `/$batch`.

Текст пакетного запроса JSON состоит из одного объекта JSON с один обязательным свойством: `requests`. Свойство `requests` является массивом отдельных запросов. Для каждого отдельного запроса требуются свойства `id`, `method` и `url`.

Основная функция свойства `id` — сопоставление отдельных запросов и ответов. Это позволяет серверу обрабатывать запросы пакета в наиболее эффективном порядке.

Свойства `method` и `url` отображаются в начале любого HTTP-запроса. method — это метод HTTP, а URL — это URL-адрес ресурса, на который обычно отправляется отдельный запрос.

Отдельные запросы также могут содержать свойства `headers` и `body`. Обычно это объекты JSON, как показано в предыдущем примере. В некоторых случаях `body` может быть значением в кодировке URL Base64, а не объектом JSON (например, если body представляет собой изображение). Когда в запрос включено свойство `body`, объект `headers` должен содержать значение для свойства `Content-Type`.

## <a name="response-format"></a>Формат ответа

Формат ответа для пакетных запросов JSON почти такой же, как формат запроса. Ниже приведены основные различия.

* Свойство в основном объекте JSON называется `responses`, а не `requests`.
* Порядок отображения ответов и запросов может отличаться.
* Вместо свойств `method` и `url` отдельные ответы содержат свойство `status`. Значение `status` — это код состояния HTTP.

Пакетный ответ обычно содержит код состояния `200` или `400`. Если пакетный запрос имеет неправильный формат, код состояния — `400`. Если пакетный запрос пригоден для анализа, код состояния — `200`. Код состояния `200` пакетного ответа не указывает на успешное выполнение отдельных запросов в пакете. Именно поэтому у каждого отдельного ответа в свойстве `responses` есть код состояния.

## <a name="sequencing-requests-with-the-dependson-property"></a>Выстраивание последовательности запросов с помощью свойства dependsOn

С помощью свойства `dependsOn` можно задать порядок выполнения запросов. Это свойство представляет собой массив строк, которые ссылаются на значения `id` различных отдельных запросов. Поэтому значения `id` должны быть уникальными. Например, в следующем запросе клиент указывает, что в первую очередь нужно выполнить запросы 1 и 3, затем запросы 2 и 4.

```json
{
  "requests": [
    {
      "id": "1",
      "method": "GET",
      "url": "..."
    },
    {
      "id": "2",
      "dependsOn": [ "1" ],
      "method": "GET",
      "url": "..."
    },
    {
      "id": "3",
      "method": "GET",
      "url": "..."
    },
    {
      "id": "4",
      "dependsOn": [ "2" ],
      "method": "GET",
      "url": "..."
    }
  ]
}
```

Если отдельный запрос не будет выполнен, то любой зависящий от него запрос также не будет выполнен с кодом состояния `424` (ошибка зависимости).

## <a name="bypassing-url-length-limitations-with-batching"></a>Обход ограничения на длину URL-адреса с помощью пакетной обработки

Еще один вариант использования пакетной обработки JSON — обход ограничения на длину URL-адреса. Если предложение фильтра сложное, длина URL-адреса может превышать ограничения, встроенные в браузеры или другие HTTP-клиенты. Для выполнения таких запросов можно использовать пакетную обработку JSON, так как длинные URL-адреса просто станут частью полезных данных запроса.

## <a name="known-issues"></a>Известные проблемы

Список текущих ограничений, связанных с пакетной обработкой, см. в разделе [Известные проблемы][batching-known-issues].

[batching-known-issues]: known-issues.md#json-batching
[odata-4.01-json]: https://www.oasis-open.org/committees/download.php/60365/odata-json-format-v4.01-wd02-2017-03-24.docx


## <a name="see-also"></a>См. также

Дополнительные сведения о формате пакетных запросов и ответов JSON см. в [спецификации формата JSON OData версии 4.01](http://docs.oasis-open.org/odata/odata-json-format/v4.01/odata-json-format-v4.01.html#sec_BatchRequestsandResponses), раздел _Пакетные запросы и ответы_.
